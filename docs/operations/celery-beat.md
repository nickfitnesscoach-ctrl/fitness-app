# Celery Beat ‚Äî –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏ EatFit24

## –û–±–∑–æ—Ä

Celery Beat ‚Äî –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞—á –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ EatFit24.

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**
- Scheduler: `celery.beat.PersistentScheduler`
- –§–∞–π–ª —Å–æ—Å—Ç–æ—è–Ω–∏—è: `/app/celerybeat-schedule` (–≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)
- –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á: –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ –≤ –∫–æ–¥–µ ([backend/config/celery.py](../../backend/config/celery.py))
- –û—á–µ—Ä–µ–¥—å: `billing` (dedicated queue –¥–ª—è –ø–ª–∞—Ç—ë–∂–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π)

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ: SSOT (Single Source of Truth)

### ‚úÖ –ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ

**–ö–æ–¥ —è–≤–ª—è–µ—Ç—Å—è –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –ø—Ä–∞–≤–¥—ã.**

- –í—Å–µ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏ –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è **—Ç–æ–ª—å–∫–æ** –≤ `config/celery.py`
- –§–∞–π–ª `celerybeat-schedule` ‚Äî —ç—Ç–æ **runtime-–∞—Ä—Ç–µ—Ñ–∞–∫—Ç**, –∫–æ—Ç–æ—Ä—ã–π –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∏–∑ –∫–æ–¥–∞
- –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –≤ –∫–æ–¥–µ **–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä** celery-beat

### ‚ö†Ô∏è –í–∞–∂–Ω–∞—è –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å PersistentScheduler

`PersistentScheduler` **–ù–ï —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** —Å –∫–æ–¥–æ–º!

–ï—Å–ª–∏ –≤—ã –∏–∑–º–µ–Ω–∏–ª–∏ `app.conf.beat_schedule` –≤ –∫–æ–¥–µ, –Ω–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å ‚Äî **–∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ –ø—Ä–∏–º–µ–Ω—è—Ç—Å—è**, –ø–æ–∫–∞ –≤—ã –Ω–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–¥–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä.

**–°–∏–º–ø—Ç–æ–º—ã —É—Å—Ç–∞—Ä–µ–≤—à–µ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è:**
- –ù–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ –∏–∑ –∫–æ–¥–∞ –Ω–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è
- –£–¥–∞–ª—ë–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è
- –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –Ω–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è

> **Golden rule:**
> **–ò–∑–º–µ–Ω–∏–ª `beat_schedule` ‚Üí –ø–µ—Ä–µ—Å–æ–∑–¥–∞–π celery-beat. –í—Å–µ–≥–¥–∞.**

### üìå –¢–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—è

**–ü–æ–¥ "–ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞" –ø–æ–Ω–∏–º–∞–µ—Ç—Å—è:**
- `docker compose rm -f celery-beat` ‚Äî —É–¥–∞–ª–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
- –∑–∞—Ç–µ–º `docker compose up -d celery-beat` ‚Äî —Å–æ–∑–¥–∞—Ç—å –∑–∞–Ω–æ–≤–æ

‚ö†Ô∏è **`docker restart` –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–µ–Ω** ‚Äî —Ñ–∞–π–ª `celerybeat-schedule` —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –∏ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è —É—Å—Ç–∞—Ä–µ–≤—à–∏–º!

---

## –¢–∞–π–º–∑–æ–Ω–∞

### –¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

**Django settings:**
- `TIME_ZONE = "Europe/Moscow"`
- `USE_TZ = True`

**Beat –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä:**
- –†–∞–±–æ—Ç–∞–µ—Ç –≤ `UTC` (—Å–∏—Å—Ç–µ–º–Ω–æ–µ –≤—Ä–µ–º—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)
- Celery –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `Europe/Moscow` –∏–∑ Django settings –¥–ª—è crontab-—Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π

‚ö†Ô∏è **–í–∞–∂–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å:**
- `crontab(minute=0, hour="*/1")` —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤ **00:00, 01:00, 02:00 –ø–æ Moscow time**
- –≠—Ç–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç **21:00, 22:00, 23:00 UTC –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –¥–Ω—è**
- –í –ª–æ–≥–∞—Ö Beat –≤—Ä–µ–º—è –ø–æ–∫–∞–∑–∞–Ω–æ –∫–∞–∫ `LocalTime` –≤ UTC+3 (–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è + Django TIME_ZONE)

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–π–º–∑–æ–Ω—ã

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
docker exec eatfit24-celery-beat-1 date
# –í—ã–≤–æ–¥: UTC +0000

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Django settings
docker exec eatfit24-backend-1 python manage.py shell -c "
from django.conf import settings
print(f'TIME_ZONE: {settings.TIME_ZONE}')
print(f'USE_TZ: {settings.USE_TZ}')
"
# –í—ã–≤–æ–¥: TIME_ZONE: Europe/Moscow, USE_TZ: True
```

### Troubleshooting —Ç–∞–π–º–∑–æ–Ω—ã

**–°–∏–º–ø—Ç–æ–º:** Hourly –∑–∞–¥–∞—á–∞ –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ –æ–∂–∏–¥–∞–µ–º–æ–µ –≤—Ä–µ–º—è

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
1. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏ Beat ‚Äî —Ç–∞–º —É–∫–∞–∑–∞–Ω–æ `LocalTime`
2. –°–≤–µ—Ä—å—Ç–µ —Å –≤–∞—à–∏–º–∏ –æ–∂–∏–¥–∞–Ω–∏—è–º–∏ (Moscow time –∏–ª–∏ UTC?)
3. –ï—Å–ª–∏ hourly –∑–∞–¥–∞—á–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –Ω–∞ `0 */1`, –æ–Ω–∞ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç –≤ **–Ω–∞—á–∞–ª–µ –∫–∞–∂–¥–æ–≥–æ —á–∞—Å–∞ –ø–æ Moscow time**

**–ü—Ä–∏–º–µ—Ä:**
- –°–µ–π—á–∞—Å 12:05 UTC (15:05 Moscow)
- –°–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—É—Å–∫: 16:00 Moscow = 13:00 UTC

---

## –¢–µ–∫—É—â–∏–µ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏

### 1. `billing-retry-stuck-webhooks`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** Recovery –¥–ª—è –∑–∞—Å—Ç—Ä—è–≤—à–∏—Ö webhooks

**–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:** `*/5` (–∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç)

**–õ–æ–≥–∏–∫–∞:**
- –ù–∞—Ö–æ–¥–∏—Ç WebhookLog –≤ —Å—Ç–∞—Ç—É—Å–µ `PROCESSING` —Å—Ç–∞—Ä—à–µ 10 –º–∏–Ω—É—Ç
- –ü–µ—Ä–µ–≤–æ–¥–∏—Ç –∏—Ö –æ–±—Ä–∞—Ç–Ω–æ –≤ `QUEUED`
- –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É —á–µ—Ä–µ–∑ `process_yookassa_webhook.delay()`

**–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```python
logger.info("[WEBHOOK_RECOVERY] no stuck webhooks found")
logger.warning("[WEBHOOK_RECOVERY] found %s stuck webhooks, retrying...", count)
logger.info("[WEBHOOK_RECOVERY] requeued %s stuck webhooks", count)
```

**–ö–æ–¥:** [backend/apps/billing/webhooks/tasks.py:108](../../backend/apps/billing/webhooks/tasks.py#L108)

---

### 2. `billing-alert-failed-webhooks`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** Alerting –¥–ª—è FAILED webhooks

**–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:** `*/15` (–∫–∞–∂–¥—ã–µ 15 –º–∏–Ω—É—Ç)

**–õ–æ–≥–∏–∫–∞:**
- –ù–∞—Ö–æ–¥–∏—Ç WebhookLog –≤ —Å—Ç–∞—Ç—É—Å–µ `FAILED` –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å
- –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–æ >= 1, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∞–ª–µ—Ä—Ç –≤ Telegram –∞–¥–º–∏–Ω–∞–º
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–æ 5 –ø—Ä–∏–º–µ—Ä–æ–≤ –æ—à–∏–±–æ–∫

**–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```python
logger.info("[WEBHOOK_ALERT] no failed webhooks in last hour")
logger.warning("[WEBHOOK_ALERT] sent alert for %s failed webhooks", count)
```

**–ö–æ–¥:** [backend/apps/billing/webhooks/tasks.py:190](../../backend/apps/billing/webhooks/tasks.py#L190)

---

### 3. `billing-cleanup-pending-payments`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** Cleanup –¥–ª—è PENDING –ø–ª–∞—Ç–µ–∂–µ–π —Å—Ç–∞—Ä—à–µ 24 —á–∞—Å–æ–≤

**–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:** `0 */1` (–∫–∞–∂–¥—ã–π —á–∞—Å –≤ :00)

**–õ–æ–≥–∏–∫–∞:**
- –ù–∞—Ö–æ–¥–∏—Ç Payment –≤ —Å—Ç–∞—Ç—É—Å–µ `PENDING` —Å—Ç–∞—Ä—à–µ 24 —á–∞—Å–æ–≤
- –ü–µ—Ä–µ–≤–æ–¥–∏—Ç –∏—Ö –≤ `CANCELED` —Å –ø—Ä–∏—á–∏–Ω–æ–π "no webhook received"
- –ï—Å–ª–∏ >= 3 –ø–ª–∞—Ç–µ–∂–µ–π, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∞–ª–µ—Ä—Ç –∞–¥–º–∏–Ω–∞–º

**–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```python
logger.info("[PAYMENT_CLEANUP] no stuck pending payments found")
logger.warning("[PAYMENT_CLEANUP] canceled %s stuck pending payments", updated)
```

**–ö–æ–¥:** [backend/apps/billing/webhooks/tasks.py:228](../../backend/apps/billing/webhooks/tasks.py#L228)

---

## –ö–∞–∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏

### ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–ø–æ—Å–æ–± (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∫—Ä–∏–ø—Ç [scripts/reset-celery-beat.sh](../../scripts/reset-celery-beat.sh):

```bash
cd /opt/EatFit24
./scripts/reset-celery-beat.sh
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç:**
1. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∏–∑ –∫–æ–¥–∞
2. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∏ —É–¥–∞–ª—è–µ—Ç celery-beat –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
3. –ü–µ—Ä–µ—Å–æ–∑–¥–∞—ë—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (—Ñ–∞–π–ª `celerybeat-schedule` —Å–æ–∑–¥–∞—ë—Ç—Å—è –∑–∞–Ω–æ–≤–æ)
4. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —É—Å–ø–µ—à–Ω—ã–π –∑–∞–ø—É—Å–∫
5. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ª–æ–≥–∏ –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- –ü–æ—Å–ª–µ –ª—é–±–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è `app.conf.beat_schedule` –≤ –∫–æ–¥–µ
- –ï—Å–ª–∏ –∑–∞–¥–∞—á–∏ "–∂–∏–≤—É—Ç —Å–≤–æ–µ–π –∂–∏–∑–Ω—å—é"
- –ü—Ä–∏ –ø–æ–¥–æ–∑—Ä–µ–Ω–∏–∏ –Ω–∞ —É—Å—Ç–∞—Ä–µ–≤—à–µ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ

---

### ‚öôÔ∏è –†—É—á–Ω–æ–π —Å–ø–æ—Å–æ–±

–ï—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–ª–∏ –Ω—É–∂–µ–Ω –∫–æ–Ω—Ç—Ä–æ–ª—å –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞.

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É

1. –î–æ–±–∞–≤—å—Ç–µ –∑–∞–¥–∞—á—É –≤ `config/celery.py`:
   ```python
   app.conf.beat_schedule = {
       # ... existing tasks ...
       "new-task-name": {
           "task": "apps.module.tasks.new_task",
           "schedule": crontab(minute="*/10"),
       },
   }
   ```

2. –ü–µ—Ä–µ—Å–æ–∑–¥–∞–π—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä celery-beat:
   ```bash
   cd /opt/EatFit24
   sudo docker compose rm -f celery-beat
   sudo docker compose up -d celery-beat
   ```

3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∑–∞–¥–∞—á–∞ –ø–æ—è–≤–∏–ª–∞—Å—å –≤ –ª–æ–≥–∞—Ö:
   ```bash
   sudo docker logs -f eatfit24-celery-beat-1 | grep "new-task-name"
   ```

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ò–∑–º–µ–Ω–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∑–∞–¥–∞—á–∏

1. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `schedule` –≤ `config/celery.py`

2. –ü–µ—Ä–µ—Å–æ–∑–¥–∞–π—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (—Å–º. –≤—ã—à–µ)

3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –Ω–æ–≤—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–∏–º–µ–Ω–∏–ª—Å—è:
   - –°–ª–µ–¥–∏—Ç–µ –∑–∞ –ª–æ–≥–∞–º–∏ Beat
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∑–∞–¥–∞—á–∞ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ –Ω–æ–≤–æ–º—É —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É

1. –£–¥–∞–ª–∏—Ç–µ –∑–∞–ø–∏—Å—å –∏–∑ `app.conf.beat_schedule`

2. –ü–µ—Ä–µ—Å–æ–∑–¥–∞–π—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä

3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∑–∞–¥–∞—á–∞ –±–æ–ª—å—à–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è

---

## –ß—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ –∑–∞–¥–∞—á–∏ "–∂–∏–≤—É—Ç —Å–≤–æ–µ–π –∂–∏–∑–Ω—å—é"

### –°–∏–º–ø—Ç–æ–º—ã

- –ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, —Ö–æ—Ç—è —É–¥–∞–ª–µ–Ω–∞ –∏–∑ –∫–æ–¥–∞
- –ó–∞–¥–∞—á–∞ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, —Ö–æ—Ç—è –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –∫–æ–¥
- –ò–Ω—Ç–µ—Ä–≤–∞–ª –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–¥—É

### –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –≤ –∫–æ–¥–µ:**
   ```bash
   docker exec eatfit24-backend-1 python manage.py shell -c "
   from config.celery import app
   for name in app.conf.beat_schedule.keys():
       print(name)
   "
   ```

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–≥–¥–∞ –±—ã–ª —Å–æ–∑–¥–∞–Ω —Ñ–∞–π–ª `celerybeat-schedule`:**
   ```bash
   docker exec eatfit24-celery-beat-1 stat /app/celerybeat-schedule
   ```

   –ï—Å–ª–∏ –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è **—Å—Ç–∞—Ä—à–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞** ‚Äî —Ñ–∞–π–ª —É—Å—Ç–∞—Ä–µ–ª!

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Beat:**
   ```bash
   docker logs --tail 100 eatfit24-celery-beat-1 | grep "Sending due task"
   ```

### –†–µ—à–µ–Ω–∏–µ

**–ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –∫–æ–¥–æ–º:**

```bash
cd /opt/EatFit24

# 1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∏ —É–¥–∞–ª–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
sudo docker compose rm -f celery-beat

# 2. –ü–µ—Ä–µ—Å–æ–∑–¥–∞–π—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (—Ñ–∞–π–ª –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –∑–∞–Ω–æ–≤–æ –∏–∑ –∫–æ–¥–∞)
sudo docker compose up -d celery-beat

# 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏
sudo docker logs -f eatfit24-celery-beat-1
```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞:**
- –í –ª–æ–≥–∞—Ö –ø–æ—è–≤–∏–ª–æ—Å—å: `beat: Starting...`
- –ß–µ—Ä–µ–∑ 1-2 –º–∏–Ω—É—Ç—ã –≤–∏–¥–∏—Ç–µ: `Scheduler: Sending due task ...` –¥–ª—è –≤—Å–µ—Ö –∑–∞–¥–∞—á
- –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–¥—É

---

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ë—ã—Å—Ç—Ä—ã–π sanity-check —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è

–ü–µ—Ä–≤–∞—è –∫–æ–º–∞–Ω–¥–∞ –ø—Ä–∏ –ª—é–±–æ–º —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–∏ ‚Äî –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –≤ –∫–æ–¥–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–∂–∏–¥–∞–Ω–∏—è–º:

```bash
docker exec eatfit24-backend-1 python - <<'PY'
from config.celery import app
print("=== Beat schedule from code ===")
for k, v in app.conf.beat_schedule.items():
    print(f"  {k}")
    print(f"    schedule: {v['schedule']}")
    print(f"    task: {v['task']}")
PY
```

**–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:**
```
=== Beat schedule from code ===
  billing-retry-stuck-webhooks
    schedule: <crontab: */5 * * * * (m/h/dM/MY/d)>
    task: apps.billing.webhooks.tasks.retry_stuck_webhooks
  billing-alert-failed-webhooks
    schedule: <crontab: */15 * * * * (m/h/dM/MY/d)>
    task: apps.billing.webhooks.tasks.alert_failed_webhooks
  billing-cleanup-pending-payments
    schedule: <crontab: 0 */1 * * * (m/h/dM/MY/d)>
    task: apps.billing.webhooks.tasks.cleanup_pending_payments
```

–ï—Å–ª–∏ –≤—ã–≤–æ–¥ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –æ–∂–∏–¥–∞–Ω–∏—è–º–∏ ‚Äî –ø—Ä–æ–±–ª–µ–º–∞ –≤ –∫–æ–¥–µ, –∞ –Ω–µ –≤ Beat.

---

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è Beat

```bash
# –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
docker ps | grep celery-beat

# –õ–æ–≥–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –º–∏–Ω—É—Ç
docker logs --since 5m eatfit24-celery-beat-1

# –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –∑–∞–¥–∞—á–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è
docker logs --since 1h eatfit24-celery-beat-1 | grep "Sending due task" | wc -l
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á –Ω–∞ Worker

```bash
# –õ–æ–≥–∏ worker –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å
docker logs --since 1h eatfit24-celery-worker-1 | grep -E "(billing.*webhook|cleanup_pending)"

# –£—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
docker logs --since 1h eatfit24-celery-worker-1 | grep "succeeded"
```

### –û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ

**–ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç (–≤ :00, :05, :10, :15, ...):**
- Beat: `Sending due task billing-retry-stuck-webhooks`
- Worker: `Task ... succeeded` –∏–ª–∏ –ª–æ–≥–∏ –∏–∑ –∑–∞–¥–∞—á–∏

**–ö–∞–∂–¥—ã–µ 15 –º–∏–Ω—É—Ç (–≤ :00, :15, :30, :45):**
- Beat: `Sending due task billing-alert-failed-webhooks`
- Worker: `[WEBHOOK_ALERT] no failed webhooks in last hour` (–µ—Å–ª–∏ –≤—Å—ë –û–ö)

**–ö–∞–∂–¥—ã–π —á–∞—Å (–≤ :00):**
- Beat: `Sending due task billing-cleanup-pending-payments`
- Worker: `[PAYMENT_CLEANUP] no stuck pending payments found` (–µ—Å–ª–∏ –≤—Å—ë –û–ö)

---

## Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: –ó–∞–¥–∞—á–∏ –Ω–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è

**–ü—Ä–æ–≤–µ—Ä–∫–∏:**

1. Beat –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω?
   ```bash
   docker ps | grep celery-beat
   ```

2. Worker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω –∏ —Å–ª—É—à–∞–µ—Ç –æ—á–µ—Ä–µ–¥—å `billing`?
   ```bash
   docker logs --tail 50 eatfit24-celery-worker-1 | grep "billing"
   ```

3. Redis –¥–æ—Å—Ç—É–ø–µ–Ω?
   ```bash
   docker exec eatfit24-redis-1 redis-cli PING
   ```

4. –ó–∞–¥–∞—á–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è Beat'–æ–º?
   ```bash
   docker logs --tail 20 eatfit24-celery-beat-1
   ```

---

### –ü—Ä–æ–±–ª–µ–º–∞: Hourly –∑–∞–¥–∞—á–∞ –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**

1. **–§–∞–π–ª `celerybeat-schedule` —É—Å—Ç–∞—Ä–µ–ª** (—Å–º. —Ä–∞–∑–¥–µ–ª "–ß—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ –∑–∞–¥–∞—á–∏ –∂–∏–≤—É—Ç —Å–≤–æ–µ–π –∂–∏–∑–Ω—å—é")

2. **Beat —Å—Ç–∞—Ä—Ç–æ–≤–∞–ª –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ —á–∞—Å–∞** ‚Äî —Å–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ –≤ –Ω–∞—á–∞–ª–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ —á–∞—Å–∞ (–≤ :00)

3. **–¢–∞–π–º–∑–æ–Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞** ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Beat, —Ç–∞–º —É–∫–∞–∑–∞–Ω–æ `LocalTime`, —Å–≤–µ—Ä—å—Ç–µ —Å –æ–∂–∏–¥–∞–µ–º—ã–º –≤—Ä–µ–º–µ–Ω–µ–º

**–†–µ—à–µ–Ω–∏–µ:** –ü–µ—Ä–µ—Å–æ–∑–¥–∞–π—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (—Å–º. –≤—ã—à–µ)

---

## –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: django-celery-beat

–ï—Å–ª–∏ –≤ –±—É–¥—É—â–µ–º –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º —á–µ—Ä–µ–∑ Django Admin:

### –ü–ª—é—Å—ã

- –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –±–µ–∑ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
- UI –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∞–º–∏
- –ò—Å—Ç–æ—Ä–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

### –ú–∏–Ω—É—Å—ã

- –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –≤ –ë–î, –∞ –Ω–µ –≤ –∫–æ–¥–µ (—Ç–µ—Ä—è–µ–º SSOT –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏)
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å
- –¢—Ä–µ–±—É–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–π

### –ü–µ—Ä–µ—Ö–æ–¥

1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ `django-celery-beat`:
   ```bash
   pip install django-celery-beat
   ```

2. –î–æ–±–∞–≤—å—Ç–µ –≤ `INSTALLED_APPS`:
   ```python
   INSTALLED_APPS = [
       ...
       'django_celery_beat',
   ]
   ```

3. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏:
   ```bash
   python manage.py migrate django_celery_beat
   ```

4. –ò–∑–º–µ–Ω–∏—Ç–µ scheduler –≤ `docker-compose.yml`:
   ```yaml
   celery-beat:
     command: celery -A config beat -l info --scheduler django_celery_beat.schedulers:DatabaseScheduler
   ```

5. –°–æ–∑–¥–∞–π—Ç–µ –∑–∞–¥–∞—á–∏ —á–µ—Ä–µ–∑ Django Admin –∏–ª–∏ management command

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ü–æ–∫–∞ –ø—Ä–æ–µ–∫—Ç –Ω–µ–±–æ–ª—å—à–æ–π ‚Äî –æ—Å—Ç–∞–≤–∞–π—Ç–µ—Å—å –Ω–∞ `PersistentScheduler`. –ö–æ–¥ –∫–∞–∫ SSOT –ø—Ä–æ—â–µ –∏ –Ω–∞–¥—ë–∂–Ω–µ–µ.

---

## –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

| –î–∞—Ç–∞       | –ò–∑–º–µ–Ω–µ–Ω–∏–µ                                                    | –ê–≤—Ç–æ—Ä         |
|------------|--------------------------------------------------------------|---------------|
| 2025-12-24 | –ê—É–¥–∏—Ç –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è Celery Beat                             | DevOps Agent  |
| 2025-12-24 | –£—Å—Ç—Ä–∞–Ω–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å hourly –∑–∞–¥–∞—á–µ–π (–ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞) | DevOps Agent  |
| 2025-12-24 | –î–æ–±–∞–≤–ª–µ–Ω—ã: Golden rule, —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—è, —Ç–∞–π–º–∑–æ–Ω–∞, sanity-check | DevOps Agent  |
| 2025-12-24 | –°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç reset-celery-beat.sh (–∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è Golden Rule) | DevOps Agent  |

---

## –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [Time & Timezone Policy](../architecture/time.md) ‚Äî —Å–∏—Å—Ç–µ–º–Ω–∞—è –ø–æ–ª–∏—Ç–∏–∫–∞ –≤—Ä–µ–º–µ–Ω–∏
- [Celery Configuration](../../backend/config/celery.py) ‚Äî –∫–æ–¥ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
- [Billing Tasks](../../backend/apps/billing/webhooks/tasks.py) ‚Äî —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–¥–∞—á
- [Reset Beat Script](../../scripts/reset-celery-beat.sh) ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è
- [Backend Deployment](../deployment/backend.md) (–µ—Å–ª–∏ –µ—Å—Ç—å)
- [Billing Webhooks Architecture](../architecture/billing-webhooks.md) (–µ—Å–ª–∏ –µ—Å—Ç—å)

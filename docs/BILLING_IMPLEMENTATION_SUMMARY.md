# Billing Settings Implementation ‚Äî Summary

## –û–±–∑–æ—Ä

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã backend-—Ä—É—á–∫–∏ –¥–ª—è —ç–∫—Ä–∞–Ω–∞ "–ù–∞—Å—Ç—Ä–æ–π–∫–∏" –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–æ–π –≤ Telegram Mini App EatFit24. –í—Å–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–∏—Å—Ç–µ–º–æ–π –ø–ª–∞—Ç–µ–∂–µ–π —á–µ—Ä–µ–∑ –ÆKassa –∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–∫—Ä—ã—Ç—ã —Ç–µ—Å—Ç–∞–º–∏.

---

## –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### 1. –ú–æ–¥–µ–ª–∏ (Database Schema)

#### –û–±–Ω–æ–≤–ª–µ–Ω–∞ –º–æ–¥–µ–ª—å `Subscription` ([backend/apps/billing/models.py:120-133](backend/apps/billing/models.py#L120-L133))

–î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç–µ:

```python
card_mask = models.CharField(
    '–ú–∞—Å–∫–∞ –∫–∞—Ä—Ç—ã',
    max_length=20,
    blank=True,
    null=True,
    help_text='–ü–æ—Å–ª–µ–¥–Ω–∏–µ 4 —Ü–∏—Ñ—Ä—ã –∫–∞—Ä—Ç—ã, –Ω–∞–ø—Ä–∏–º–µ—Ä "‚Ä¢‚Ä¢‚Ä¢‚Ä¢ 1234"'
)

card_brand = models.CharField(
    '–¢–∏–ø –∫–∞—Ä—Ç—ã',
    max_length=50,
    blank=True,
    null=True,
    help_text='–¢–∏–ø –ø–ª–∞—Ç—ë–∂–Ω–æ–π –∫–∞—Ä—Ç—ã: Visa, MasterCard, –ú–ò–† –∏ —Ç.–¥.'
)
```

#### –ú–∏–≥—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

–°–æ–∑–¥–∞–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è: [backend/apps/billing/migrations/0004_add_card_fields_to_subscription.py](backend/apps/billing/migrations/0004_add_card_fields_to_subscription.py)

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:**
```bash
cd backend
python manage.py migrate billing
```

---

### 2. API Endpoints

–í—Å–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ –ø—Ä–µ—Ñ–∏–∫—Å—É `/api/v1/billing/` –∏ —Ç—Ä–µ–±—É—é—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Telegram WebApp –∏–ª–∏ JWT.

#### 2.1 GET `/subscription/`
([backend/apps/billing/views.py:493-574](backend/apps/billing/views.py#L493-L574))

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–¥–ø–∏—Å–∫–µ –¥–ª—è —ç–∫—Ä–∞–Ω–∞ "–ù–∞—Å—Ç—Ä–æ–π–∫–∏"

**Response:**
```json
{
  "plan": "free" | "pro",
  "plan_display": "Free" | "PRO",
  "expires_at": "2025-12-26" | null,
  "is_active": true,
  "autorenew_available": false,
  "autorenew_enabled": false,
  "payment_method": {
    "is_attached": false,
    "card_mask": null,
    "card_brand": null
  }
}
```

#### 2.2 POST `/subscription/autorenew/`
([backend/apps/billing/views.py:577-640](backend/apps/billing/views.py#L577-L640))

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –í–∫–ª—é—á–µ–Ω–∏–µ/–æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏

**Request:**
```json
{
  "enabled": true
}
```

**Response:** –¢–æ—Ç –∂–µ —Ñ–æ—Ä–º–∞—Ç, —á—Ç–æ –∏ GET `/subscription/` —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏

**–û—à–∏–±–∫–∏:**
- `400`: `payment_method_required` ‚Äî –Ω–µ—Ç –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç—ã
- `400`: `NOT_AVAILABLE_FOR_FREE` ‚Äî –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø–ª–∞–Ω
- `404`: `NO_SUBSCRIPTION` ‚Äî –Ω–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏

#### 2.3 GET `/payment-method/`
([backend/apps/billing/views.py:643-674](backend/apps/billing/views.py#L643-L674))

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç–µ

**Response:**
```json
{
  "is_attached": true,
  "card_mask": "‚Ä¢‚Ä¢‚Ä¢‚Ä¢ 1234",
  "card_brand": "Visa"
}
```

#### 2.4 GET `/payments/`
([backend/apps/billing/views.py:677-742](backend/apps/billing/views.py#L677-L742))

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**Query params:**
- `limit` (optional, default: 10, max: 100)

**Response:**
```json
{
  "results": [
    {
      "id": "uuid",
      "amount": 299.00,
      "currency": "RUB",
      "status": "succeeded",
      "paid_at": "2025-02-10T12:34:56Z",
      "description": "–ü–æ–¥–ø–∏—Å–∫–∞ Pro –ú–µ—Å—è—á–Ω—ã–π"
    }
  ]
}
```

---

### 3. Serializers

–°–æ–∑–¥–∞–Ω—ã –Ω–æ–≤—ã–µ serializers –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö ([backend/apps/billing/serializers.py:123-204](backend/apps/billing/serializers.py#L123-L204)):

- `PaymentMethodSerializer` ‚Äî –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞—Ä—Ç–µ
- `SubscriptionStatusSerializer` ‚Äî –ø–æ–ª–Ω—ã–π —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏
- `AutoRenewToggleSerializer` ‚Äî –≤–∫–ª—é—á–µ–Ω–∏–µ/–æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏—è
- `PaymentHistoryItemSerializer` ‚Äî —ç–ª–µ–º–µ–Ω—Ç –∏—Å—Ç–æ—Ä–∏–∏ –ø–ª–∞—Ç–µ–∂–µ–π
- `PaymentHistoryResponseSerializer` ‚Äî —Å–ø–∏—Å–æ–∫ –ø–ª–∞—Ç–µ–∂–µ–π

---

### 4. URL Routes

–î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã ([backend/apps/billing/urls.py:20-24](backend/apps/billing/urls.py#L20-L24)):

```python
# NEW: Settings screen endpoints
path('subscription/', views.get_subscription_details, name='subscription-details'),
path('subscription/autorenew/', views.set_auto_renew, name='set-auto-renew'),
path('payment-method/', views.get_payment_method_details, name='payment-method-details'),
path('payments/', views.get_payments_history, name='payments-history'),
```

---

### 5. Webhook Integration

–û–±–Ω–æ–≤–ª–µ–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ `payment.succeeded` ([backend/apps/billing/webhooks.py:211-229](backend/apps/billing/webhooks.py#L211-L229)):

**–ß—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–∞—Ä—Ç–µ –∏–∑ `payment_object.payment_method.card`
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ `card_mask` (—Ñ–æ—Ä–º–∞—Ç: "‚Ä¢‚Ä¢‚Ä¢‚Ä¢ 1234")
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ `card_brand` (Visa, MasterCard, –ú–ò–†)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ `auto_renew = True` –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç–µ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –∫–∞—Ä—Ç—ã

```python
# –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞—Ä—Ç–µ –∏–∑ payment_object
if payment_object.payment_method and hasattr(payment_object.payment_method, 'card'):
    card_info = payment_object.payment_method.card
    if card_info:
        # –§–æ—Ä–º–∏—Ä—É–µ–º –º–∞—Å–∫—É –∫–∞—Ä—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä "‚Ä¢‚Ä¢‚Ä¢‚Ä¢ 1234")
        if hasattr(card_info, 'last4'):
            subscription.card_mask = f"‚Ä¢‚Ä¢‚Ä¢‚Ä¢ {card_info.last4}"

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–∏–ø –∫–∞—Ä—Ç—ã (Visa, MasterCard, –ú–ò–† –∏ —Ç.–¥.)
        if hasattr(card_info, 'card_type'):
            subscription.card_brand = card_info.card_type.upper()
```

---

### 6. Tests

–°–æ–∑–¥–∞–Ω—ã –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è –≤—Å–µ—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ ([backend/apps/billing/tests.py:355-825](backend/apps/billing/tests.py#L355-L825)):

#### Test Coverage:

**`SubscriptionDetailsTestCase` (6 —Ç–µ—Å—Ç–æ–≤):**
- Free –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±–µ–∑ –ø–æ–¥–ø–∏—Å–∫–∏
- Free –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å –ø–æ–¥–ø–∏—Å–∫–æ–π
- PRO –±–µ–∑ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç—ã
- PRO —Å –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç–æ–π
- –ë–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (401)

**`AutoRenewToggleTestCase` (4 —Ç–µ—Å—Ç–∞):**
- –ü–æ–ø—ã—Ç–∫–∞ –≤–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ –±–µ–∑ –∫–∞—Ä—Ç—ã ‚Üí 400
- –í–∫–ª—é—á–µ–Ω–∏–µ –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏—è —Å –∫–∞—Ä—Ç–æ–π ‚Üí —É—Å–ø–µ—Ö
- –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏—è ‚Üí —É—Å–ø–µ—Ö
- –ü–æ–ø—ã—Ç–∫–∞ –Ω–∞ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–º –ø–ª–∞–Ω–µ ‚Üí 400

**`PaymentMethodDetailsTestCase` (2 —Ç–µ—Å—Ç–∞):**
- –ë–µ–∑ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç—ã
- –° –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç–æ–π

**`PaymentsHistoryTestCase` (4 —Ç–µ—Å—Ç–∞):**
- –ü—É—Å—Ç–∞—è –∏—Å—Ç–æ—Ä–∏—è
- –ò—Å—Ç–æ—Ä–∏—è —Å –¥–∞–Ω–Ω—ã–º–∏
- –ü–∞—Ä–∞–º–µ—Ç—Ä limit
- –ò–∑–æ–ª—è—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)

**–ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤:**
```bash
cd backend
python manage.py test apps.billing
```

**–ó–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã—Ö —Ç–µ—Å—Ç–æ–≤:**
```bash
python manage.py test apps.billing.tests.SubscriptionDetailsTestCase
python manage.py test apps.billing.tests.AutoRenewToggleTestCase
python manage.py test apps.billing.tests.PaymentMethodDetailsTestCase
python manage.py test apps.billing.tests.PaymentsHistoryTestCase
```

---

## –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### API Documentation
–ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞–º: [docs/billing-settings-api.md](docs/billing-settings-api.md)

**–°–æ–¥–µ—Ä–∂–∏—Ç:**
- –û–ø–∏—Å–∞–Ω–∏–µ –≤—Å–µ—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤
- –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –æ—Ç–≤–µ—Ç–æ–≤
- –ö–æ–¥—ã –æ—à–∏–±–æ–∫
- Contract guarantees (–≥–∞—Ä–∞–Ω—Ç–∏–∏ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ API)
- –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ
- Integration notes

### Manual Testing Checklist
–ß–µ–∫-–ª–∏—Å—Ç –¥–ª—è —Ä—É—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: [docs/billing_manual_test.md](docs/billing_manual_test.md)

**–°–æ–¥–µ—Ä–∂–∏—Ç:**
- –ü–æ—à–∞–≥–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- –¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –¥–ª—è –≤—Å–µ—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤
- E2E —Ç–µ—Å—Ç: –ø–æ–∫—É–ø–∫–∞ PRO ‚Üí –ø—Ä–∏–≤—è–∑–∫–∞ –∫–∞—Ä—Ç—ã ‚Üí –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ
- –ü—Ä–æ–≤–µ—Ä–∫–∞ UI —ç–∫—Ä–∞–Ω–∞ "–ù–∞—Å—Ç—Ä–æ–π–∫–∏"
- –†–µ–≥—Ä–µ—Å—Å–∏–æ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –¥–∏–∑–∞–π–Ω-—Ä–µ—à–µ–Ω–∏—è

### 1. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

‚úÖ **–í—Å–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã —Ç—Ä–µ–±—É—é—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Å–∏—Å—Ç–µ–º–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ Telegram WebApp
- –ö–ª–∞—Å—Å—ã: `TelegramWebAppAuthentication`, `TelegramHeaderAuthentication`

‚úÖ **–ò–∑–æ–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**
- –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ
- –ù–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö**
- `payment_method_id` –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ API (—Ç–æ–ª—å–∫–æ –≤ –ë–î)
- –í–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ `card_mask` –∏ `card_brand` (–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)

### 2. –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

‚úÖ **–ù–µ –ª–æ–º–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã**
- –°—Ç–∞—Ä—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã (`/billing/plan`, `/billing/me/`) –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
- –ù–æ–≤—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–æ–ø–æ–ª–Ω—è—é—Ç, –∞ –Ω–µ –∑–∞–º–µ–Ω—è—é—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ

‚úÖ **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –º–æ–¥–µ–ª–µ–π**
- –î–æ–±–∞–≤–ª–µ–Ω—ã —Ç–æ–ª—å–∫–æ 2 –ø–æ–ª—è –≤ `Subscription` (card_mask, card_brand)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–æ–¥–ø–∏—Å–æ–∫

### 3. –£–¥–æ–±—Å—Ç–≤–æ –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞

‚úÖ **–ï–¥–∏–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è —ç–∫—Ä–∞–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫**
- `GET /subscription/` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –í–°–Å –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ –¥–ª—è UI –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º
- –ù–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –¥–µ–ª–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø—Ä–æ—Å–æ–≤

‚úÖ **–ü–æ–Ω—è—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö**
- `plan`: "free" –∏–ª–∏ "pro" (lowercase) ‚Äî —É–¥–æ–±–Ω–æ –¥–ª—è —É—Å–ª–æ–≤–∏–π
- `expires_at`: –¥–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ ISO –∏–ª–∏ null ‚Äî –ø–æ–Ω—è—Ç–Ω–∞—è —Å–µ–º–∞–Ω—Ç–∏–∫–∞
- `autorenew_available` vs `autorenew_enabled` ‚Äî —è–≤–Ω–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ

‚úÖ **–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—à–∏–±–æ–∫**
```json
{
  "error": {
    "code": "ERROR_CODE",
    "message": "Human readable message"
  }
}
```

### 4. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

‚úÖ **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `select_related()` –≥–¥–µ –Ω—É–∂–Ω–æ
- –ù–µ—Ç N+1 –ø—Ä–æ–±–ª–µ–º—ã
- –ò–Ω–¥–µ–∫—Å—ã –Ω–∞ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø–æ–ª—è —É–∂–µ —Å–æ–∑–¥–∞–Ω—ã

‚úÖ **–ü—Ä–æ—Å—Ç—ã–µ –∑–∞–ø—Ä–æ—Å—ã**
- –í—Å–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–µ–ª–∞—é—Ç 1-2 –∑–∞–ø—Ä–æ—Å–∞ –∫ –ë–î
- –ù–µ—Ç —Ç—è–∂–µ–ª—ã—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π

---

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–æ–¥–æ–º

### –ß—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–æ–¥–∞:

1. **–ú–æ–¥–µ–ª–∏:**
   - `Subscription` ‚Äî —Ä–∞—Å—à–∏—Ä–µ–Ω–∞ 2 –ø–æ–ª—è–º–∏
   - `Payment` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
   - `SubscriptionPlan` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

2. **–°–µ—Ä–≤–∏—Å—ã:**
   - `YooKassaService` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–µ–π
   - `activate_or_extend_subscription()` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ webhook
   - `get_effective_plan_for_user()` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–ª–∞–Ω–∞

3. **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è:**
   - `TelegramWebAppAuthentication` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–æ –≤—Å–µ—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞—Ö
   - `TelegramHeaderAuthentication` ‚Äî –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥

4. **Webhooks:**
   - `handle_payment_succeeded()` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç—ã

---

## Migration Path (–¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞)

### –°—Ç–∞—Ä—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã (deprecated, –Ω–æ —Ä–∞–±–æ—Ç–∞—é—Ç):
- `POST /billing/auto-renew/toggle` ‚Üí –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `/subscription/autorenew/`
- `GET /billing/payments` ‚Üí –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `/payments/` (—Å trailing slash)

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:

**–î–ª—è —ç–∫—Ä–∞–Ω–∞ "–ù–∞—Å—Ç—Ä–æ–π–∫–∏":**
```typescript
// 1. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —ç–∫—Ä–∞–Ω–∞
const subscription = await fetch('/api/v1/billing/subscription/').then(r => r.json());

// 2. –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏—è
const updated = await fetch('/api/v1/billing/subscription/autorenew/', {
  method: 'POST',
  body: JSON.stringify({ enabled: true })
}).then(r => r.json());

// 3. –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –ø–ª–∞—Ç–µ–∂–µ–π
const { results } = await fetch('/api/v1/billing/payments/?limit=10').then(r => r.json());
```

---

## Checklist –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º

### Backend:
- [x] –ú–∏–≥—Ä–∞—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω—ã
- [ ] –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –Ω–∞ –ø—Ä–æ–¥–µ (`python manage.py migrate`)
- [x] –¢–µ—Å—Ç—ã –∑–µ–ª–µ–Ω—ã–µ
- [ ] YooKassa credentials –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã (YOOKASSA_SHOP_ID, YOOKASSA_SECRET_KEY)
- [ ] –¢–∞—Ä–∏—Ñ–Ω—ã–µ –ø–ª–∞–Ω—ã —Å–æ–∑–¥–∞–Ω—ã —á–µ—Ä–µ–∑ Django Admin (FREE, MONTHLY, YEARLY)

### Frontend:
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω API client —Å –Ω–æ–≤—ã–º–∏ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞–º–∏
- [ ] TypeScript —Ç–∏–ø—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã
- [ ] UI —ç–∫—Ä–∞–Ω–∞ "–ù–∞—Å—Ç—Ä–æ–π–∫–∏" –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å –Ω–æ–≤—ã–º–∏ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞–º–∏
- [ ] –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
- [ ] –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ —á–µ–∫-–ª–∏—Å—Ç—É ([docs/billing_manual_test.md](docs/billing_manual_test.md))
- [ ] E2E —Ç–µ—Å—Ç: –ø–æ–∫—É–ø–∫–∞ ‚Üí –ø—Ä–∏–≤—è–∑–∫–∞ –∫–∞—Ä—Ç—ã ‚Üí –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –∫–∞—Ä—Ç–∞—Ö YooKassa

---

## Files Modified/Created

### Modified:
- `backend/apps/billing/models.py` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è card_mask, card_brand
- `backend/apps/billing/webhooks.py` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω handle_payment_succeeded
- `backend/apps/billing/views.py` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω—ã 4 –Ω–æ–≤—ã—Ö view —Ñ—É–Ω–∫—Ü–∏–∏
- `backend/apps/billing/serializers.py` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω—ã 5 –Ω–æ–≤—ã—Ö serializers
- `backend/apps/billing/urls.py` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω—ã 4 –Ω–æ–≤—ã—Ö –º–∞—Ä—à—Ä—É—Ç–∞
- `backend/apps/billing/tests.py` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω—ã 4 –Ω–æ–≤—ã—Ö test case –∫–ª–∞—Å—Å–∞

### Created:
- `backend/apps/billing/migrations/0004_add_card_fields_to_subscription.py` ‚Äî –º–∏–≥—Ä–∞—Ü–∏—è –ë–î
- `docs/billing-settings-api.md` ‚Äî –ø–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API
- `docs/billing_manual_test.md` ‚Äî —á–µ–∫-–ª–∏—Å—Ç —Ä—É—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- `docs/BILLING_IMPLEMENTATION_SUMMARY.md` ‚Äî —ç—Ç–æ—Ç —Ñ–∞–π–ª

---

## Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: 401 Unauthorized
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:
- Telegram WebApp: `X-Telegram-Init-Data`
- JWT: `Authorization: Bearer <token>`

### –ü—Ä–æ–±–ª–µ–º–∞: autorenew_available = false –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã
**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ webhook `payment.succeeded` –æ—Ç—Ä–∞–±–æ—Ç–∞–ª
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `tail -f backend/logs/django.log`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ YooKassa –≤–µ—Ä–Ω—É–ª `payment_method.card` –≤ webhook

### –ü—Ä–æ–±–ª–µ–º–∞: card_mask –∏ card_brand = null
**–†–µ—à–µ–Ω–∏–µ:**
1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞ `save_payment_method = True`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ YooKassa SDK –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `payment_method.card.last4` –∏ `card_type`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ webhook –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞

### –ü—Ä–æ–±–ª–µ–º–∞: –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è
**–†–µ—à–µ–Ω–∏–µ:**
```bash
cd backend
python manage.py showmigrations billing  # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
python manage.py migrate billing  # –ü—Ä–∏–º–µ–Ω–∏—Ç—å
```

---

## –ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞

- **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API:** [docs/billing-settings-api.md](docs/billing-settings-api.md)
- **–ß–µ–∫-–ª–∏—Å—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:** [docs/billing_manual_test.md](docs/billing_manual_test.md)
- **–û—Å–Ω–æ–≤–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** [docs/rest-api-docs.md](docs/rest-api-docs.md)

---

## –ò—Ç–æ–≥–∏

‚úÖ **4 –Ω–æ–≤—ã—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞** –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã
‚úÖ **16 –Ω–æ–≤—ã—Ö —Ç–µ—Å—Ç–æ–≤** –ø–æ–∫—Ä—ã–≤–∞—é—Ç –≤—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
‚úÖ **–ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤—â–∏–∫–æ–≤
‚úÖ **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** ‚Äî —Å—Ç–∞—Ä—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** ‚Äî –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã, –ø–ª–∞—Ç–µ–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞—â–∏—â–µ–Ω—ã
‚úÖ **–ì–æ—Ç–æ–≤–æ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É** ‚Äî —Ç–æ–ª—å–∫–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å credentials

–í—Å–µ –≥–æ—Ç–æ–≤–æ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞! üöÄ

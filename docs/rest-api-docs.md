# REST API Documentation ‚Äî EatFit24

**Base URL:** `/api/v1/`
**Authentication:** JWT Token / Telegram WebApp headers

---

## Authentication

### Telegram WebApp (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –º–∏–Ω–∏-–∞–ø–ø)

```
X-Telegram-Init-Data: <init_data>
X-Telegram-User-Id: <user_id>
X-Telegram-User-Hash: <hash>
```

### JWT Token

```
Authorization: Bearer <access_token>
```

---

## üõ° Contract Guarantees

**–≠—Ç–∏ –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã –ù–ï–õ–¨–ó–Ø –º–µ–Ω—è—Ç—å –±–µ–∑ MAJOR –≤–µ—Ä—Å–∏–∏ API (v2+)**

### 1. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ AI —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è

```json
{
  "recognized_items": [...],
  "total_calories": <number>,
  "total_protein": <number>,
  "total_fat": <number>,
  "total_carbohydrates": <number>
}
```

**–ì–∞—Ä–∞–Ω—Ç–∏–∏:**
- `recognized_items` –≤—Å–µ–≥–¥–∞ –º–∞—Å—Å–∏–≤ (–º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º)
- –í—Å–µ –ø–æ–ª—è `total_*` –≤—Å–µ–≥–¥–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç (—á–∏—Å–ª–æ ‚â• 0)
- –í–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–µ—â–µ–Ω–∞ ‚Äî –Ω–µ—Ç –æ–±—ë—Ä—Ç–æ–∫ —Ç–∏–ø–∞ `{ "data": {...} }`

### 2. –ü–æ–ª—è `recognized_items[]` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ)

```json
{
  "name": string,           // –ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞
  "grams": integer,         // –í–µ—Å –≤ –≥—Ä–∞–º–º–∞—Ö
  "calories": number,       // –ö–∞–ª–æ—Ä–∏–∏
  "protein": number,        // –ë–µ–ª–∫–∏ (–≥)
  "fat": number,           // –ñ–∏—Ä—ã (–≥)
  "carbohydrates": number  // –£–≥–ª–µ–≤–æ–¥—ã (–≥)
}
```

**–ì–∞—Ä–∞–Ω—Ç–∏–∏:**
- –í—Å–µ –ø–æ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã
- `grams` ‚Äî —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ ‚â• 0
- –û—Å—Ç–∞–ª—å–Ω—ã–µ —á–∏—Å–ª–æ–≤—ã–µ –ø–æ–ª—è ‚Äî float ‚â• 0
- `name` ‚Äî –Ω–µ–ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞

### 3. –§–æ—Ä–º–∞—Ç –æ—à–∏–±–æ–∫ (–µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–π)

```json
{
  "error": "<ERROR_CODE>",
  "detail": "<human readable message>"
}
```

**–ì–∞—Ä–∞–Ω—Ç–∏–∏:**
- –ü–æ–ª–µ `error` ‚Äî –º–∞—à–∏–Ω–Ω—ã–π –∫–æ–¥ (UPPERCASE_SNAKE_CASE)
- –ü–æ–ª–µ `detail` ‚Äî —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
- –û–±–∞ –ø–æ–ª—è –≤—Å–µ–≥–¥–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç

### 4. AI endpoint HTTP —Å—Ç–∞—Ç—É—Å—ã

**–†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ –∫–æ–¥—ã:**
- `200` ‚Äî —É—Å–ø–µ—Ö (–≤–∫–ª—é—á–∞—è `NO_FOOD_DETECTED`)
- `400` ‚Äî –æ—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- `401` ‚Äî –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
- `429` ‚Äî –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç
- `500` ‚Äî –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–∏—Å–∞

**–ó–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ –∫–æ–¥—ã:**
- `404` ‚Äî AI endpoint –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç Not Found
- `204` ‚Äî AI endpoint –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç No Content

### 5. –ó–∞–ø—Ä–µ—Ç –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏

**‚ùå –ó–∞–ø—Ä–µ—â–µ–Ω–æ:**
```json
{
  "data": {
    "recognized_items": [...]
  }
}
```

**‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ:**
```json
{
  "recognized_items": [...]
}
```

---

## Endpoints

### AI Recognition

#### `POST /api/v1/ai/recognize/`

–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –µ–¥—ã –ø–æ —Ñ–æ—Ç–æ —Å –ø–æ–º–æ—â—å—é AI.

**Request:**
```json
{
  "image": "data:image/jpeg;base64,/9j/4AAQSkZJRg...",
  "description": "–û–≤—Å—è–Ω–∫–∞ –Ω–∞ –º–æ–ª–æ–∫–µ 2.5%, 1 —á.–ª. —Å–∞—Ö–∞—Ä–∞"
}
```

**Response (200 OK):**
```json
{
  "recognized_items": [
    {
      "name": "–û–≤—Å—è–Ω–∫–∞ –Ω–∞ –º–æ–ª–æ–∫–µ 2.5%",
      "grams": 300,
      "calories": 320,
      "protein": 12.5,
      "fat": 8.2,
      "carbohydrates": 48.0
    }
  ],
  "total_calories": 320.0,
  "total_protein": 12.5,
  "total_fat": 8.2,
  "total_carbohydrates": 48.0
}
```

**Errors:**
- `400` ‚Äî `INVALID_IMAGE` / `MISSING_IMAGE`
- `401` ‚Äî `UNAUTHORIZED`
- `429` ‚Äî `RATE_LIMIT_EXCEEDED` (10/–º–∏–Ω, 100/–¥–µ–Ω—å)
- `500` ‚Äî `AI_SERVICE_ERROR`

**–ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** [AI Food Recognition](./ai_food_recognition.md)

#### ‚úî Request Validation Rules

| –ü–æ–ª–µ | –¢–∏–ø | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ | –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è |
|------|-----|-------------|-------------|
| `image` | Base64 Data URL | –î–∞ | JPEG/PNG, max 10MB, max 4096√ó4096px |
| `description` | string | –ù–µ—Ç | ‚â§ 500 —Å–∏–º–≤–æ–ª–æ–≤ |

**–í–∞–ª–∏–¥–∞—Ü–∏—è `image`:**
- –î–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å `data:image/`
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ MIME: `jpeg`, `jpg`, `png`
- Base64 —á–∞—Å—Ç—å –¥–æ–ª–∂–Ω–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- Magic bytes —Ñ–∞–π–ª–∞ –¥–æ–ª–∂–Ω—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å JPEG (`FF D8 FF`) –∏–ª–∏ PNG (`89 50 4E 47`)
- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 10√ó10 –ø–∏–∫—Å–µ–ª–µ–π
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 4096√ó4096 –ø–∏–∫—Å–µ–ª–µ–π (16 –º–µ–≥–∞–ø–∏–∫—Å–µ–ª–µ–π)

#### ‚úî Response Validation Rules (Frontend must enforce)

**–ü–æ–ª–µ `recognized_items`:**
- –í—Å–µ–≥–¥–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- –¢–∏–ø: –º–∞—Å—Å–∏–≤
- –ù–µ `null` (–º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º `[]`)

**–ü–æ–ª—è –≤–Ω—É—Ç—Ä–∏ `items`:**
- `name`: –Ω–µ–ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞
- `grams`: integer ‚â• 0
- `calories`, `protein`, `fat`, `carbohydrates`: number ‚â• 0

**–ü–æ–ª—è `total_*`:**
- –í—Å–µ–≥–¥–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç
- –¢–∏–ø: number ‚â• 0

#### üîß cURL Examples

**–£—Å–ø–µ—à–Ω–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ:**
```bash
curl -X POST "http://localhost:8000/api/v1/ai/recognize/" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -d '{
    "image": "data:image/jpeg;base64,/9j/4AAQSkZJRg...",
    "description": "–∫–∞—à–∞ —Å –º—ë–¥–æ–º"
  }'
```

**–° Telegram WebApp headers:**
```bash
curl -X POST "http://localhost:8000/api/v1/ai/recognize/" \
  -H "Content-Type: application/json" \
  -H "X-Telegram-Init-Data: query_id=..." \
  -H "X-Telegram-User-Id: 123456" \
  -H "X-Telegram-User-Hash: abc..." \
  -d '{
    "image": "data:image/jpeg;base64,/9j/4AAQSkZJRg...",
    "description": ""
  }'
```

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ñ–∞–π–ª–æ–º:**
```bash
# –°–æ–∑–¥–∞—Ç—å base64 –∏–∑ —Ñ–∞–π–ª–∞
IMAGE_BASE64=$(base64 -w 0 food.jpg)

# –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å
curl -X POST "http://localhost:8000/api/v1/ai/recognize/" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d "{\"image\": \"data:image/jpeg;base64,$IMAGE_BASE64\", \"description\": \"\"}"
```

---

### Meals (–ü—Ä–∏—ë–º—ã –ø–∏—â–∏)

#### `GET /api/v1/meals/?date=YYYY-MM-DD`

–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –ø—Ä–∏—ë–º—ã –ø–∏—â–∏ –∑–∞ –¥–µ–Ω—å.

**Response (200 OK):**
```json
[
  {
    "id": 123,
    "date": "2025-11-26",
    "meal_type": "BREAKFAST",
    "items": [
      {
        "id": 456,
        "name": "–û–≤—Å—è–Ω–∫–∞",
        "grams": 300,
        "calories": 320,
        "protein": 12.5,
        "fat": 8.2,
        "carbohydrates": 48.0
      }
    ],
    "total_calories": 320,
    "total_protein": 12.5,
    "total_fat": 8.2,
    "total_carbohydrates": 48.0
  }
]
```

---

#### `POST /api/v1/meals/`

–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–∏—ë–º –ø–∏—â–∏.

**Request:**
```json
{
  "date": "2025-11-26",
  "meal_type": "LUNCH"
}
```

**Response (201 Created):**
```json
{
  "id": 789,
  "date": "2025-11-26",
  "meal_type": "LUNCH",
  "items": [],
  "total_calories": 0,
  "total_protein": 0,
  "total_fat": 0,
  "total_carbohydrates": 0
}
```

---

#### `POST /api/v1/meals/{meal_id}/items/`

–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç –≤ –ø—Ä–∏—ë–º –ø–∏—â–∏.

**Request:**
```json
{
  "name": "–ö—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞",
  "grams": 150,
  "calories": 165,
  "protein": 31.0,
  "fat": 3.6,
  "carbohydrates": 0.0
}
```

**Response (201 Created):**
```json
{
  "id": 456,
  "name": "–ö—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞",
  "grams": 150,
  "calories": 165,
  "protein": 31.0,
  "fat": 3.6,
  "carbohydrates": 0.0
}
```

---

### Goals (–î–Ω–µ–≤–Ω—ã–µ —Ü–µ–ª–∏)

#### `GET /api/v1/goals/`

–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –¥–Ω–µ–≤–Ω—ã–µ —Ü–µ–ª–∏ –ø–æ –ö–ë–ñ–£.

**Response (200 OK):**
```json
{
  "id": 1,
  "calories": 2000,
  "protein": 150.0,
  "fat": 67.0,
  "carbohydrates": 200.0,
  "source": "MANUAL",
  "is_active": true,
  "created_at": "2025-11-26T10:00:00Z"
}
```

**Response (404):** –¶–µ–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã

---

#### `PUT /api/v1/goals/`

–û–±–Ω–æ–≤–∏—Ç—å –¥–Ω–µ–≤–Ω—ã–µ —Ü–µ–ª–∏.

**Request:**
```json
{
  "calories": 2200,
  "protein": 160.0,
  "fat": 70.0,
  "carbohydrates": 220.0
}
```

**Response (200 OK):**
```json
{
  "id": 1,
  "calories": 2200,
  "protein": 160.0,
  "fat": 70.0,
  "carbohydrates": 220.0,
  "source": "MANUAL",
  "is_active": true,
  "created_at": "2025-11-26T10:00:00Z",
  "updated_at": "2025-11-26T12:00:00Z"
}
```

---

#### `POST /api/v1/goals/calculate/`

–†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ü–µ–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**Response (200 OK):**
```json
{
  "calories": 2000,
  "protein": 150.0,
  "fat": 67.0,
  "carbohydrates": 200.0
}
```

---

### User Profile

#### `GET /api/v1/users/profile/`

–ü–æ–ª—É—á–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**Response (200 OK):**
```json
{
  "id": 123,
  "username": "user123",
  "email": "user@example.com",
  "profile": {
    "age": 30,
    "gender": "M",
    "height": 180,
    "weight": 80.0,
    "activity_level": "MODERATE",
    "goal": "MAINTAIN",
    "avatar": "https://example.com/avatars/123.jpg"
  }
}
```

---

#### `PATCH /api/v1/users/profile/`

–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**Request:**
```json
{
  "age": 31,
  "weight": 78.5,
  "activity_level": "HIGH"
}
```

**Response (200 OK):** –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å

---

#### `POST /api/v1/users/profile/avatar/`

–ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤–∞—Ç–∞—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**Request:** `multipart/form-data`
```
avatar: <file>
```

**Response (200 OK):**
```json
{
  "profile": {
    "avatar": "https://example.com/avatars/123_updated.jpg"
  }
}
```

---

## Error Codes

–í—Å–µ –æ—à–∏–±–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ:

```json
{
  "error": "ERROR_CODE",
  "detail": "–ß–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏"
}
```

### –û–±—â–∏–µ –∫–æ–¥—ã:

| –ö–æ–¥ | HTTP | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----|------|----------|
| `UNAUTHORIZED` | 401 | –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω |
| `FORBIDDEN` | 403 | –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω |
| `NOT_FOUND` | 404 | –†–µ—Å—É—Ä—Å –Ω–µ –Ω–∞–π–¥–µ–Ω |
| `VALIDATION_ERROR` | 400 | –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö |
| `RATE_LIMIT_EXCEEDED` | 429 | –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ |
| `INTERNAL_ERROR` | 500 | –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ |

### AI Recognition:

| –ö–æ–¥ | HTTP | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----|------|----------|
| `INVALID_IMAGE` | 400 | –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ |
| `MISSING_IMAGE` | 400 | –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ |
| `NO_FOOD_DETECTED` | 200 | –ï–¥–∞ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞ (–ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫) |
| `AI_SERVICE_ERROR` | 500 | –û—à–∏–±–∫–∞ AI —Å–µ—Ä–≤–∏—Å–∞ |

---

## Rate Limits

| Endpoint | –õ–∏–º–∏—Ç |
|----------|-------|
| `/api/v1/ai/recognize/` | 10/–º–∏–Ω, 100/–¥–µ–Ω—å (–ø–æ IP) |
| –û—Å—Ç–∞–ª—å–Ω—ã–µ endpoints | –ë–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π |

---

## Pagination

–î–ª—è —Å–ø–∏—Å–∫–æ–≤—ã—Ö endpoint'–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è pagination:

```json
{
  "count": 100,
  "next": "http://api.example.com/api/v1/meals/?page=2",
  "previous": null,
  "results": [...]
}
```

---

## Versioning

–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è API: **v1**

URL format: `/api/v1/<endpoint>/`

---

## üîÅ Retry Rules (Frontend)

| –ö–æ–¥ –æ—à–∏–±–∫–∏ | Retry? | –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ | –î–µ–π—Å—Ç–≤–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
|------------|--------|-------------|----------------------|
| `AI_SERVICE_ERROR` | ‚úÖ –î–∞ | –î–æ 3 –ø–æ–ø—ã—Ç–æ–∫ | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º |
| `RATE_LIMIT_EXCEEDED` | ‚úÖ –î–∞ | –ß–µ—Ä–µ–∑ 60 —Å–µ–∫—É–Ω–¥ | –ü–æ–∫–∞–∑–∞—Ç—å —Ç–∞–π–º–µ—Ä: "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ 60 —Å–µ–∫" |
| `INVALID_IMAGE` | ‚ùå –ù–µ—Ç | - | –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–µ —Ñ–æ—Ç–æ |
| `MISSING_IMAGE` | ‚ùå –ù–µ—Ç | - | UI –±–∞–≥ ‚Äî –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å |
| `UNAUTHORIZED` | ‚ùå –ù–µ—Ç | - | –ü–æ–ª–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ WebApp (–ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç—å –∏–∑ Telegram) |
| `NO_FOOD_DETECTED` | ‚ö†Ô∏è –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ | 1 –ø–æ–ø—ã—Ç–∫–∞ | –°–æ–æ–±—â–µ–Ω–∏–µ + –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Å–¥–µ–ª–∞—Ç—å –∫–∞–¥—Ä –±–ª–∏–∂–µ / —Å–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ |

**–ü—Ä–∞–≤–∏–ª–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**

1. **`AI_SERVICE_ERROR`** ‚Äî –≤—Ä–µ–º–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ —Å–µ—Ä–≤–∏—Å–∞:
   - Retry –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
   - –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å "–ü–æ–ø—ã—Ç–∫–∞ X –∏–∑ 3"
   - –ü–æ—Å–ª–µ 3 –ø–æ–ø—ã—Ç–æ–∫: "–í—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–µ —Ñ–æ—Ç–æ"

2. **`RATE_LIMIT_EXCEEDED`** ‚Äî –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç:
   - –ù–ï –¥–µ–ª–∞—Ç—å –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π retry
   - –ü–æ–∫–∞–∑–∞—Ç—å countdown: "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ 58 —Å–µ–∫—É–Ω–¥..."
   - –ü–æ—Å–ª–µ —Ç–∞–π–º–µ—Ä–∞ —Ä–∞–∑—Ä–µ—à–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—É—é –ø–æ–ø—ã—Ç–∫—É

3. **`NO_FOOD_DETECTED`** ‚Äî –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
   - –ú–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å 1 –ø–æ–≤—Ç–æ—Ä–Ω—É—é –ø–æ–ø—ã—Ç–∫—É (–Ω–∞ —É—Å–º–æ—Ç—Ä–µ–Ω–∏–µ UX)
   - –ï—Å–ª–∏ –ø–æ–≤—Ç–æ—Ä –Ω–µ –ø–æ–º–æ–≥ ‚Üí "–í—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–µ —Ñ–æ—Ç–æ"
   - –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É: "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–¥–µ–ª–∞—Ç—å –∫–∞–¥—Ä –±–ª–∏–∂–µ"

4. **`INVALID_IMAGE` / `MISSING_IMAGE`** ‚Äî –ø—Ä–æ–±–ª–µ–º–∞ —Å –¥–∞–Ω–Ω—ã–º–∏:
   - Retry –±–µ—Å–ø–æ–ª–µ–∑–µ–Ω
   - –°—Ä–∞–∑—É –ø–æ–∫–∞–∑–∞—Ç—å "–í—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–µ —Ñ–æ—Ç–æ"

5. **`UNAUTHORIZED`** ‚Äî —Å–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞:
   - Retry –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω
   - –ü–æ–∫–∞–∑–∞—Ç—å: "–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–Ω–æ–≤–æ –∏–∑ Telegram"

---

## üîß Change Control Policy

**–ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –º–µ–Ω—è—Ç—å API –±–µ–∑ –ø–æ–ª–æ–º–æ–∫**

### MINOR-–∏–∑–º–µ–Ω–µ–Ω–∏—è (—Ä–∞–∑—Ä–µ—à–µ–Ω—ã –±–µ–∑ –º–∏–≥—Ä–∞—Ü–∏–∏)

‚úÖ **–î–æ–ø—É—Å—Ç–∏–º–æ:**
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π –≤ –æ—Ç–≤–µ—Ç
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –∫–æ–¥–æ–≤ –æ—à–∏–±–æ–∫ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–≤–µ–¥–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π `meal_type` (BREAKFAST, LUNCH, DINNER, SNACK, ...)
- –£–ª—É—á—à–µ–Ω–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–æ–Ω–Ω–æ–π –ª–æ–≥–∏–∫–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞
- –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, max image size 10MB ‚Üí 15MB)

üìù **–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
- –î–æ–±–∞–≤–∏—Ç—å –≤ CHANGELOG —Å –ø–æ–º–µ—Ç–∫–æ–π `[MINOR]`
- –û–±–Ω–æ–≤–∏—Ç—å OpenAPI schema

### PATCH-–∏–∑–º–µ–Ω–µ–Ω–∏—è (—Ç—Ä–µ–±—É—é—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏)

‚úÖ **–î–æ–ø—É—Å—Ç–∏–º–æ:**
- –ò–∑–º–µ–Ω–µ–Ω–∏—è UI-–ø–æ–≤–µ–¥–µ–Ω–∏—è (retry –ª–æ–≥–∏–∫–∞, —Ç–∞–π–º–∞—É—Ç—ã)
- –£–ª—É—á—à–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤ –æ—à–∏–±–æ–∫ (–¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è `detail`)
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–æ–≤ –ª–æ–≥–æ–≤ (DEBUG/INFO —É—Ä–æ–≤–Ω–∏)
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞

üìù **–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
- –£–≤–µ–¥–æ–º–∏—Ç—å –∫–æ–º–∞–Ω–¥—É —á–µ—Ä–µ–∑ Slack/issue

### MAJOR-breaking changes (–ó–ê–ü–†–ï–©–ï–ù–´ –±–µ–∑ API v2)

‚ùå **–ó–∞–ø—Ä–µ—â–µ–Ω–æ:**
- –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—è –∏–∑ –æ—Ç–≤–µ—Ç–∞
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –ø–æ–ª—è (`estimated_weight` ‚Üí `grams` ‚Äî —ç—Ç–æ breaking change!)
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–∏–ø–∞ –ø–æ–ª—è (integer ‚Üí string, array ‚Üí object)
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –æ—Ç–≤–µ—Ç–∞ (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—ë—Ä—Ç–∫–∏ `{ "data": {...} }`)
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ HTTP —Å—Ç–∞—Ç—É—Å-–∫–æ–¥–æ–≤ (200 ‚Üí 201, 500 ‚Üí 400)
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏ JSON
- –£–¥–∞–ª–µ–Ω–∏–µ –∏–ª–∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ endpoint

üö® **–ï—Å–ª–∏ –Ω—É–∂–µ–Ω breaking change:**
1. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π endpoint `/api/v2/...`
2. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å `/api/v1/...` –º–∏–Ω–∏–º—É–º 6 –º–µ—Å—è—Ü–µ–≤
3. –î–æ–±–∞–≤–∏—Ç—å deprecation warning –≤ `/api/v1/...`
4. –û–±–Ω–æ–≤–∏—Ç—å –≤—Å—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
5. –£–≤–µ–¥–æ–º–∏—Ç—å –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –∑–∞ 1 –º–µ—Å—è—Ü

---

## ü§ù Backend ‚áÑ Frontend Sync Checklist

**–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ—Ç —á–µ–∫–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –∫–æ–º–º–∏—Ç–æ–º, –∑–∞—Ç—Ä–∞–≥–∏–≤–∞—é—â–∏–º AI —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ**

### –ü–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º Backend

- [ ] –ü—Ä–æ–≤–µ—Ä–∏–ª–∏ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é –≤ [ai_food_recognition.md](./ai_food_recognition.md)?
- [ ] –ü—Ä–æ–≤–µ—Ä–∏–ª–∏ Contract Guarantees –≤ [rest-api-docs.md](./rest-api-docs.md)?
- [ ] –ò–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–µ –Ω–∞—Ä—É—à–∞–µ—Ç –≥–∞—Ä–∞–Ω—Ç–∏–∏ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞?
- [ ] –ï—Å–ª–∏ –Ω–∞—Ä—É—à–∞–µ—Ç ‚Äî —Å–æ–∑–¥–∞–ª–∏ `/api/v2/`?

### –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è Backend

- [ ] –û–±–Ω–æ–≤–ª–µ–Ω—ã serializers (`apps/ai/serializers.py`)?
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω—ã —Ç–µ—Å—Ç—ã (`apps/ai/tests.py`)?
- [ ] –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç (`python manage.py test apps.ai`)?
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (`docs/ai_food_recognition.md`)?
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω–∞ OpenAPI schema?

### –ü—Ä–æ–≤–µ—Ä–∫–∞ Frontend —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

- [ ] –§—Ä–æ–Ω—Ç–µ–Ω–¥ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–∞—Ä—Å–∏—Ç –Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞?
- [ ] –û–±–Ω–æ–≤–ª—ë–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ (`FoodLogPage.tsx`)?
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `getErrorMessage()` –¥–ª—è –Ω–æ–≤—ã—Ö –∫–æ–¥–æ–≤?
- [ ] Retry –ª–æ–≥–∏–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –Ω–æ–≤—ã–º –ø—Ä–∞–≤–∏–ª–∞–º?
- [ ] TypeScript –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã?

### –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!)

- [ ] –£—Å–ø–µ—à–Ω–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ (–≤–∞–ª–∏–¥–Ω–æ–µ —Ñ–æ—Ç–æ –µ–¥—ã)
- [ ] –ü—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (—Ñ–æ—Ç–æ –±–µ–∑ –µ–¥—ã / –ø–µ–π–∑–∞–∂)
- [ ] –ù–µ–≤–∞–ª–∏–¥–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–±–∏—Ç—ã–π —Ñ–∞–π–ª)
- [ ] –û—à–∏–±–∫–∞ AI —Å–µ—Ä–≤–∏—Å–∞ (–æ—Ç–∫–ª—é—á–∏—Ç—å OpenRouter API key)
- [ ] Rate limit (–æ—Ç–ø—Ä–∞–≤–∏—Ç—å >10 –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ –º–∏–Ω—É—Ç—É)
- [ ] Unauthorized (—É–¥–∞–ª–∏—Ç—å auth headers)

### Integration —Ç–µ—Å—Ç—ã

- [ ] End-to-end —Ç–µ—Å—Ç —á–µ—Ä–µ–∑ Postman/curl
- [ ] –¢–µ—Å—Ç —á–µ—Ä–µ–∑ frontend dev server
- [ ] –¢–µ—Å—Ç —á–µ—Ä–µ–∑ Telegram WebApp (staging)

### –ü–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω

- [ ] –í—Å–µ —á–µ–∫–ª–∏—Å—Ç—ã –≤—ã—à–µ –ø—Ä–æ–π–¥–µ–Ω—ã?
- [ ] Code review –∑–∞–≤–µ—Ä—à—ë–Ω?
- [ ] Staging —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏?
- [ ] –û–±–Ω–æ–≤–ª—ë–Ω CHANGELOG?
- [ ] Team —É–≤–µ–¥–æ–º–ª–µ–Ω–∞ –æ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö?

---

## üìä Testing Scenarios

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –£—Å–ø–µ—à–Ω–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ

```bash
# Request
curl -X POST "http://localhost:8000/api/v1/ai/recognize/" \
  -H "Authorization: Bearer TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"image": "data:image/jpeg;base64,...", "description": ""}'

# Expected Response (200 OK)
{
  "recognized_items": [
    {"name": "–ö—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞", "grams": 150, "calories": 165, ...}
  ],
  "total_calories": 165,
  "total_protein": 31.0,
  "total_fat": 3.6,
  "total_carbohydrates": 0.0
}
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (NO_FOOD_DETECTED)

```bash
# Request: —Ñ–æ—Ç–æ –ø–µ–π–∑–∞–∂–∞
curl -X POST "http://localhost:8000/api/v1/ai/recognize/" \
  -H "Authorization: Bearer TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"image": "data:image/jpeg;base64,...", "description": ""}'

# Expected Response (200 OK)
{
  "recognized_items": [],
  "total_calories": 0,
  "total_protein": 0,
  "total_fat": 0,
  "total_carbohydrates": 0
}

# Frontend –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å:
# "–ú—ã –Ω–µ –Ω–∞—à–ª–∏ –Ω–∞ —Ñ–æ—Ç–æ –µ–¥—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–¥–µ–ª–∞—Ç—å –∫–∞–¥—Ä –±–ª–∏–∂–µ –∏–ª–∏ –ø—Ä–∏ –ª—É—á—à–µ–º –æ—Å–≤–µ—â–µ–Ω–∏–∏"
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ù–µ–≤–∞–ª–∏–¥–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ

```bash
# Request: –±–∏—Ç—ã–π base64
curl -X POST "http://localhost:8000/api/v1/ai/recognize/" \
  -H "Authorization: Bearer TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"image": "invalid-base64", "description": ""}'

# Expected Response (400 Bad Request)
{
  "error": "INVALID_IMAGE",
  "detail": "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞"
}

# Frontend: –∫–Ω–æ–ø–∫–∞ "–í—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–µ —Ñ–æ—Ç–æ"
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 4: Rate limit

```bash
# Request: 11-–π –∑–∞–ø—Ä–æ—Å –∑–∞ –º–∏–Ω—É—Ç—É
curl -X POST "http://localhost:8000/api/v1/ai/recognize/" \
  -H "Authorization: Bearer TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"image": "data:image/jpeg;base64,...", "description": ""}'

# Expected Response (429 Too Many Requests)
{
  "error": "RATE_LIMIT_EXCEEDED",
  "detail": "–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É"
}

# Frontend: countdown "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ 58 —Å–µ–∫—É–Ω–¥..."
```

---

## Additional Resources

- [AI Food Recognition (–ø–æ–¥—Ä–æ–±–Ω–æ)](./ai_food_recognition.md)
- [OpenAPI Schema](http://localhost:8000/api/schema/)
- [Swagger UI](http://localhost:8000/api/docs/)
- [IMPROVEMENTS_SUMMARY.md](../IMPROVEMENTS_SUMMARY.md) ‚Äî –∏—Å—Ç–æ—Ä–∏—è —É–ª—É—á—à–µ–Ω–∏–π

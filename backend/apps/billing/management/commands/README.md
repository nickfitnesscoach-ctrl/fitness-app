# Billing Management Commands

–≠—Ç–∞ –ø–∞–ø–∫–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç **management-–∫–æ–º–∞–Ω–¥—ã Django**, –∫–æ—Ç–æ—Ä—ã–µ –æ–±—Å–ª—É–∂–∏–≤–∞—é—Ç –∂–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –ø–æ–¥–ø–∏—Å–æ–∫ –∏ –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ –≤ —Å–∏—Å—Ç–µ–º–µ –±–∏–ª–ª–∏–Ω–≥–∞ **EatFit24**.

–ö–æ–º–∞–Ω–¥—ã **–Ω–µ –≤—ã–∑—ã–≤–∞—é—Ç—Å—è –∏–∑ API** –∏ **–Ω–µ –¥–µ—Ä–≥–∞—é—Ç—Å—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º**.  
–û–Ω–∏ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è **—Ç–æ–ª—å–∫–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ** –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é (cron / systemd timer) –∏ –æ—Ç–≤–µ—á–∞—é—Ç –∑–∞ —Ñ–æ–Ω–æ–≤—É—é –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É.

---

## –°–æ—Å—Ç–∞–≤ –ø–∞–ø–∫–∏

billing/
‚îî‚îÄ‚îÄ management/
‚îî‚îÄ‚îÄ commands/
‚îú‚îÄ‚îÄ process_recurring_payments.py
‚îî‚îÄ‚îÄ cleanup_expired_subscriptions.py

yaml
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥

---

## 1Ô∏è‚É£ process_recurring_payments.py  
### –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π (–∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ)

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–ö–æ–º–∞–Ω–¥–∞ —Å–æ–∑–¥–∞—ë—Ç **—Ä–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ –≤ YooKassa** –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —É –∫–æ—Ç–æ—Ä—ã—Ö –≤–∫–ª—é—á–µ–Ω–æ –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ.

‚ö†Ô∏è **–í–∞–∂–Ω–æ**  
–ö–æ–º–∞–Ω–¥–∞ **–ù–ï –ø—Ä–æ–¥–ª–µ–≤–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É —Å–∞–º–∞**.  
–û–Ω–∞ **—Ç–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—ë—Ç –ø–ª–∞—Ç—ë–∂**, –∞ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç **–∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ —á–µ—Ä–µ–∑ webhook YooKassa (`payment.succeeded`)**.

---

### –£—Å–ª–æ–≤–∏—è, –ø—Ä–∏ –∫–æ—Ç–æ—Ä—ã—Ö —Å–æ–∑–¥–∞—ë—Ç—Å—è –ø–ª–∞—Ç—ë–∂

–ü–æ–¥–ø–∏—Å–∫–∞ –¥–æ–ª–∂–Ω–∞:
- `auto_renew = True`
- `is_active = True`
- `end_date` —Å–∫–æ—Ä–æ –∏—Å—Ç–µ–∫–∞–µ—Ç (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚â§ 3 –¥–Ω–µ–π)
- –∏–º–µ—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π `yookassa_payment_method_id`
- –ø–ª–∞–Ω **–Ω–µ FREE**

---

### –ß—Ç–æ –¥–µ–ª–∞–µ—Ç –∫–æ–º–∞–Ω–¥–∞ –ø–æ—à–∞–≥–æ–≤–æ

1. –ò—â–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ —Å–∫–æ—Ä–æ –∑–∞–∫–∞–Ω—á–∏–≤–∞—é—Ç—Å—è  
2. –î–ª—è –∫–∞–∂–¥–æ–π –ø–æ–¥–ø–∏—Å–∫–∏:
   - –±–ª–æ–∫–∏—Ä—É–µ—Ç —Å—Ç—Ä–æ–∫—É –ø–æ–¥–ø–∏—Å–∫–∏ (`select_for_update`)
   - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ **–Ω–µ—Ç pending –ø–ª–∞—Ç–µ–∂–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞**
   - —Å–æ–∑–¥–∞—ë—Ç –ª–æ–∫–∞–ª—å–Ω—ã–π `Payment` —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `PENDING`
   - —Å–æ–∑–¥–∞—ë—Ç —Ä–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω—ã–π –ø–ª–∞—Ç—ë–∂ –≤ YooKassa (—á–µ—Ä–µ–∑ HTTPS, –±–µ–∑ SDK)
   - —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç `yookassa_payment_id`
3. –ñ–¥—ë—Ç webhook –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è (—É—Å–ø–µ—Ö / –æ—Ç–∫–∞–∑)

---

### –ó–∞—â–∏—Ç–∞ –æ—Ç –æ—à–∏–±–æ–∫

- üîí —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ + row lock
- üîÅ –∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–µ–π (pending < 24—á)
- üß∑ Idempotence-Key –¥–ª—è YooKassa
- ‚ùå –Ω–∏–∫–∞–∫–æ–≥–æ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ SDK —Å–æ—Å—Ç–æ—è–Ω–∏—è

---

### –ó–∞–ø—É—Å–∫

```bash
python manage.py process_recurring_payments
–ü–∞—Ä–∞–º–µ—Ç—Ä—ã
–ü–∞—Ä–∞–º–µ—Ç—Ä	–û–ø–∏—Å–∞–Ω–∏–µ
--days-before N	–ó–∞ —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø–ª–∞—Ç—ë–∂ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 3)
--dry-run	–ù–∏—á–µ–≥–æ –Ω–µ —Å–æ–∑–¥–∞—ë—Ç, —Ç–æ–ª—å–∫–æ –≤—ã–≤–æ–¥–∏—Ç –¥–µ–π—Å—Ç–≤–∏—è

–ü—Ä–∏–º–µ—Ä—ã
bash
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥
python manage.py process_recurring_payments --days-before 2
python manage.py process_recurring_payments --dry-run
–†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞–±–æ—Ç—ã
–í –ë–î –ø–æ—è–≤–ª—è—é—Ç—Å—è Payment:

status = PENDING

is_recurring = True

–î–∞–ª—å—à–µ —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç webhook:

SUCCEEDED ‚Üí –ø–æ–¥–ø–∏—Å–∫–∞ –ø—Ä–æ–¥–ª–µ–≤–∞–µ—Ç—Å—è

–æ—à–∏–±–∫–∞ ‚Üí –ø–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–∞–µ—Ç –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è cleanup-–∫–æ–º–∞–Ω–¥–æ–π

2Ô∏è‚É£ cleanup_expired_subscriptions.py
–û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç—ë–∫—à–∏—Ö –ø–æ–¥–ø–∏—Å–æ–∫
–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–ü—Ä–∏–≤–æ–¥–∏—Ç —Å–∏—Å—Ç–µ–º—É –≤ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –µ—Å–ª–∏ –ø–ª–∞—Ç–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–ª–∞.

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞:

–µ—Å–ª–∏ webhook –Ω–µ –ø—Ä–∏—à—ë–ª

–µ—Å–ª–∏ –ø–ª–∞—Ç—ë–∂ –Ω–µ –ø—Ä–æ—à—ë–ª

–µ—Å–ª–∏ —Å–∏—Å—Ç–µ–º–∞ –±—ã–ª–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞

–ö–∞–∫–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è
is_active = True

end_date < now

–ø–ª–∞–Ω –Ω–µ FREE

FREE –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Ç—Ä–æ–≥–∞—é—Ç—Å—è.

–ß—Ç–æ –¥–µ–ª–∞–µ—Ç –∫–æ–º–∞–Ω–¥–∞
–î–ª—è –∫–∞–∂–¥–æ–π –∏—Å—Ç—ë–∫—à–µ–π –ø–æ–¥–ø–∏—Å–∫–∏:

–ë–ª–æ–∫–∏—Ä—É–µ—Ç —Å—Ç—Ä–æ–∫—É –ø–æ–¥–ø–∏—Å–∫–∏

–ü–µ—Ä–µ–≤–æ–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –ø–ª–∞–Ω FREE

–í—ã–∫–ª—é—á–∞–µ—Ç auto_renew

–û–±–Ω–æ–≤–ª—è–µ—Ç –¥–∞—Ç—ã –ø–æ–¥–ø–∏—Å–∫–∏

‚ùó –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∫–∞—Ä—Ç–∞ –ù–ï —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è ‚Äî —ç—Ç–æ –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ–µ –±–∏–∑–Ω–µ—Å-—Ä–µ—à–µ–Ω–∏–µ.

–†–∞–±–æ—Ç–∞ —Å –∫–∞—Ä—Ç–æ–π
–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è:

yookassa_payment_method_id

card_mask

card_brand

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –æ—á–∏—â–∞—Ç—å –∫–∞—Ä—Ç—É –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ:

bash
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥
--reset-card
–ó–∞–ø—É—Å–∫
bash
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥
python manage.py cleanup_expired_subscriptions
–ü–∞—Ä–∞–º–µ—Ç—Ä—ã
–ü–∞—Ä–∞–º–µ—Ç—Ä	–û–ø–∏—Å–∞–Ω–∏–µ
--batch-size N	–†–∞–∑–º–µ—Ä –±–∞—Ç—á–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 200)
--dry-run	–¢–æ–ª—å–∫–æ –ø–æ–∫–∞–∑–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
--reset-card	–û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã

–ü—Ä–∏–º–µ—Ä—ã
bash
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥
python manage.py cleanup_expired_subscriptions --dry-run
python manage.py cleanup_expired_subscriptions --batch-size 500
python manage.py cleanup_expired_subscriptions --reset-card
–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ (prod)
–ú–∏–Ω–∏–º—É–º
process_recurring_payments ‚Äî 1 —Ä–∞–∑ –≤ —Å—É—Ç–∫–∏

cleanup_expired_subscriptions ‚Äî 1 —Ä–∞–∑ –≤ —Å—É—Ç–∫–∏

–ù–∞–¥—ë–∂–Ω–æ
process_recurring_payments ‚Äî 2 —Ä–∞–∑–∞ –≤ —Å—É—Ç–∫–∏

cleanup_expired_subscriptions ‚Äî 1 —Ä–∞–∑ –≤ —Å—É—Ç–∫–∏

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Å–∏—Å—Ç–µ–º–µ
–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ
YOOKASSA_SHOP_ID

YOOKASSA_SECRET_KEY

–ö—Ä–∏—Ç–∏—á–Ω–æ –≤–∞–∂–Ω–æ
Webhook YooKassa –¥–æ–ª–∂–µ–Ω:

–ø–æ–º–µ—á–∞—Ç—å Payment –∫–∞–∫ SUCCEEDED

–ø—Ä–æ–¥–ª–µ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É

–∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –∫—ç—à –ø–ª–∞–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–ö–ª—é—á–µ–≤–∞—è —Ñ–∏–ª–æ—Å–æ—Ñ–∏—è
–ö–æ–º–∞–Ω–¥—ã ‚â† –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞

–ö–æ–º–∞–Ω–¥—ã = —Ñ–æ–Ω–æ–≤–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è

–ò—Å—Ç–∏–Ω–∞ –≤—Å–µ–≥–¥–∞:

–≤ Payment

–≤ webhook

–≤ Subscription

–≠—Ç–∏ –∫–æ–º–∞–Ω–¥—ã –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –¥–æ–ª–∂–Ω—ã –ª–æ–º–∞—Ç—å —Å–∏—Å—Ç–µ–º—É, –¥–∞–∂–µ –µ—Å–ª–∏ –∏—Ö –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ –∏–ª–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ.
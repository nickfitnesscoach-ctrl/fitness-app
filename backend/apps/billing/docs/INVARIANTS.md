# üîí –ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã Billing

> –≠—Ç–æ –ø—Ä–∞–≤–∏–ª–∞, –∫–æ—Ç–æ—Ä—ã–µ **–ù–ò–ö–û–ì–î–ê** –Ω–µ –¥–æ–ª–∂–Ω—ã –Ω–∞—Ä—É—à–∞—Ç—å—Å—è.
> –ü—Ä–∏ –ª—é–±–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–¥–∞ ‚Äî —Å–≤–µ—Ä—è–π—Å—è —Å —ç—Ç–∏–º –¥–æ–∫—É–º–µ–Ω—Ç–æ–º.

---

## –ü–æ–¥–ø–∏—Å–∫–∞

1. **1:1 User ‚Üî Subscription**
   - –£ –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ä–æ–≤–Ω–æ –æ–¥–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∞
   - –°–æ–∑–¥–∞—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (FREE)

2. **–ü–æ–¥–ø–∏—Å–∫–∞ –º–µ–Ω—è–µ—Ç—Å—è –¢–û–õ–¨–ö–û —á–µ—Ä–µ–∑ webhook**
   - –ù–∏–∫–∞–∫–æ–π endpoint –Ω–µ –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å `Subscription.plan` –Ω–∞–ø—Ä—è–º—É—é
   - –ò—Å–∫–ª—é—á–µ–Ω–∏–µ: admin panel (—Å –ø–æ–ª–Ω—ã–º –ø–æ–Ω–∏–º–∞–Ω–∏–µ–º –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏–π)

3. **FREE –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –∏—Å—Ç–µ–∫–∞–µ—Ç**
   - `is_expired()` –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `False` –¥–ª—è FREE

---

## –ü–ª–∞—Ç–µ–∂–∏

4. **–¶–µ–Ω–∞ –ù–ò–ö–û–ì–î–ê –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç —Å —Ñ—Ä–æ–Ω—Ç–∞**
   - Frontend –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ `plan_code`
   - –°—É–º–º–∞ –±–µ—Ä—ë—Ç—Å—è –∏–∑ `SubscriptionPlan.price`

5. **–£—Å–ø–µ—Ö –ø–ª–∞—Ç–µ–∂–∞ = webhook, –Ω–µ redirect**
   - `return_url` ‚Äî —ç—Ç–æ —Ç–æ–ª—å–∫–æ UX
   - –°—Ç–∞—Ç—É—Å –º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ `payment.succeeded` –æ—Ç YooKassa

6. **Payment ID –æ—Ç YooKassa ‚Äî immutable**
   - `yookassa_payment_id` –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è

---

## Webhooks

7. **–í—Å–µ–≥–¥–∞ 200 OK (–∫—Ä–æ–º–µ 400/403)**
   - –õ—é–±–æ–π webhook –¥–æ–ª–∂–µ–Ω –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å 200
   - –ò–Ω–∞—á–µ YooKassa –±—É–¥–µ—Ç —Ä–µ—Ç—Ä–∞–∏—Ç—å –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ

8. **WebhookLog ‚Äî –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã**
   - –í—Å–µ –≤—Ö–æ–¥—è—â–∏–µ webhook –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
   - –ú–æ–∂–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Å–æ–±—ã—Ç–∏–π

9. **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞**
   - –ü–æ–≤—Ç–æ—Ä–Ω—ã–π webhook —Å —Ç–µ–º –∂–µ `event_id` –Ω–µ –¥–æ–ª–∂–µ–Ω –Ω–∏—á–µ–≥–æ –º–µ–Ω—è—Ç—å

---

## –õ–∏–º–∏—Ç—ã

10. **increment_usage() ‚Äî –¢–û–õ–¨–ö–û –ø–æ—Å–ª–µ SUCCESS**
    - –ï—Å–ª–∏ AI —É–ø–∞–ª ‚Äî –ª–∏–º–∏—Ç –Ω–µ —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è
    - –ï—Å–ª–∏ Celery retry ‚Äî –ª–∏–º–∏—Ç —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑

11. **BillingContext ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã**
    - –§—Ä–æ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç –ø–ª–∞–Ω/–ª–∏–º–∏—Ç—ã —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ `/billing/me/`
    - –õ–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–æ–∂–µ—Ç –±—ã—Ç—å stale

---

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

12. **IP Allowlist –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è webhook**
    - –¢–æ–ª—å–∫–æ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ IP YooKassa

13. **–¢–µ—Å—Ç–æ–≤—ã–µ –ø–ª–∞–Ω—ã (`is_test=True`) —Å–∫—Ä—ã—Ç—ã**
    - –ù–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ `/billing/plans/`
    - –î–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ admin

---

## –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç–æ–≤

> ‚ö†Ô∏è –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ª—é–±–æ–≥–æ –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç–∞ —Ç—Ä–µ–±—É–µ—Ç:
> 1. –û–±—Å—É–∂–¥–µ–Ω–∏—è –≤ –∫–æ–º–∞–Ω–¥–µ
> 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏—è —ç—Ç–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞
> 3. –†–µ–≤—å—é –≤—Å–µ—Ö –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã—Ö –º–µ—Å—Ç

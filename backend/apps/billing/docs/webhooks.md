# Webhooks

## –û–±–∑–æ—Ä

Webhook ‚Äî **–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã** –¥–ª—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π.

–ü–ª–∞—Ç—ë–∂ —Å—á–∏—Ç–∞–µ—Ç—Å—è —É—Å–ø–µ—à–Ω—ã–º **—Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ** –ø–æ–ª—É—á–µ–Ω–∏—è `payment.succeeded` –æ—Ç YooKassa.

---

## Endpoint

```
POST /api/v1/billing/webhooks/yookassa
```

- –ü—É–±–ª–∏—á–Ω—ã–π (AllowAny)
- –ó–∞—â–∏—â—ë–Ω IP allowlist + rate limiting
- –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `200 OK`

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
webhooks/
‚îú‚îÄ‚îÄ views.py      # –ü—Ä–∏—ë–º, –≤–∞–ª–∏–¥–∞—Ü–∏—è, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
‚îú‚îÄ‚îÄ handlers.py   # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ —Å–æ–±—ã—Ç–∏–π
‚îú‚îÄ‚îÄ tasks.py      # Celery tasks (async –æ–±—Ä–∞–±–æ—Ç–∫–∞)
‚îî‚îÄ‚îÄ utils.py      # IP allowlist
```

### –ü–æ—Ç–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏

```
1. views.py: –ø—Ä–∏—ë–º –∑–∞–ø—Ä–æ—Å–∞, –≤–∞–ª–∏–¥–∞—Ü–∏—è IP
2. views.py: –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ WebhookLog
3. views.py: –ø–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ Celery task
4. views.py: return 200 OK
5. tasks.py: async –æ–±—Ä–∞–±–æ—Ç–∫–∞
6. handlers.py: –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
7. notifications.py: Telegram-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–µ—Å–ª–∏ PRO)
```

---

## –°–æ–±—ã—Ç–∏—è

### payment.succeeded

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç handler:**
1. –ù–∞—Ö–æ–¥–∏—Ç `Payment` –ø–æ `yookassa_payment_id`
2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å (–Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω –ª–∏ —É–∂–µ)
3. –ü–æ–º–µ—á–∞–µ—Ç `SUCCEEDED`
4. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç `payment_method_id` (–¥–ª—è –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏—è)
5. –ü—Ä–æ–¥–ª–µ–≤–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É
6. –û–±–Ω–æ–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã –≤ `Subscription`
7. **–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç Telegram-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ** –∞–¥–º–∏–Ω–∞–º
8. –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –∫–µ—à

### payment.canceled

1. –ù–∞—Ö–æ–¥–∏—Ç `Payment`
2. –ï—Å–ª–∏ –Ω–µ `SUCCEEDED`/`REFUNDED` ‚Äî –ø–æ–º–µ—á–∞–µ—Ç `CANCELED`

### refund.succeeded

1. –°–æ–∑–¥–∞—ë—Ç/–æ–±–Ω–æ–≤–ª—è–µ—Ç `Refund`
2. –ü–æ–º–µ—á–∞–µ—Ç `Payment` –∫–∞–∫ `REFUNDED`

---

## IP Allowlist

```python
YOOKASSA_IP_RANGES = [
    "185.71.76.0/27",
    "185.71.77.0/27",
    "77.75.153.0/25",
    "77.75.156.11/32",
    "77.75.156.35/32",
    "77.75.154.128/25",
    "2a02:5180::/32",  # IPv6
]
```

---

## –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å

YooKassa –º–æ–∂–µ—Ç —Å–ª–∞—Ç—å –æ–¥–∏–Ω webhook –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑.

**–ó–∞—â–∏—Ç–∞:**
1. `WebhookLog.event_id` ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Å–æ–±—ã—Ç–∏—è
2. `Payment.webhook_processed_at` ‚Äî –º–µ—Ç–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º

```python
if payment.status in ("SUCCEEDED", "REFUNDED"):
    logger.info("Already processed, skipping")
    return
```

---

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–ö–∞–∂–¥—ã–π webhook –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ `WebhookLog`:

| –ü–æ–ª–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|
| `event_type` | –¢–∏–ø —Å–æ–±—ã—Ç–∏—è |
| `event_id` | ID —Å–æ–±—ã—Ç–∏—è YooKassa |
| `raw_payload` | –ü–æ–ª–Ω—ã–π payload |
| `client_ip` | IP –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è |
| `status` | –†–µ–∑—É–ª—å—Ç–∞—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ |

---

## Celery Tasks

| Task | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|
| `process_yookassa_webhook` | –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–¥–Ω–æ–≥–æ webhook |
| `retry_stuck_webhooks` | –ü–æ–≤—Ç–æ—Ä –∑–∞–≤–∏—Å—à–∏—Ö (PROCESSING >10 –º–∏–Ω) |
| `alert_failed_webhooks` | Alert –æ failed –∑–∞ —á–∞—Å |

**Retry strategy:**
- max_retries=5
- –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π backoff: 30s, 60s, 120s, 240s, 480s
- ack_late=True (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏)

---

## Troubleshooting

### –ü–ª–∞—Ç—ë–∂ –ø—Ä–æ—à—ë–ª, –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –æ–±–Ω–æ–≤–∏–ª–∞—Å—å

1. –ü—Ä–æ–≤–µ—Ä—å `WebhookLog` ‚Äî –¥–æ—à—ë–ª –ª–∏ webhook?
2. –ü—Ä–æ–≤–µ—Ä—å `Payment.webhook_processed_at` ‚Äî –æ–±—Ä–∞–±–æ—Ç–∞–Ω?
3. –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ celery worker ‚Äî –µ—Å—Ç—å –ª–∏ –æ—à–∏–±–∫–∏?

### Webhook –Ω–µ –¥–æ—Ö–æ–¥–∏—Ç

1. –ü—Ä–æ–≤–µ—Ä—å URL –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö YooKassa
2. –ü—Ä–æ–≤–µ—Ä—å IP allowlist (–º–æ–≥ –∏–∑–º–µ–Ω–∏—Ç—å—Å—è)
3. –ü—Ä–æ–≤–µ—Ä—å firewall/nginx

---

## üö´ –ó–ê–ü–†–ï–©–ï–ù–û –¥–ª—è handlers.py

- ‚ùå –î–µ–ª–∞—Ç—å HTTP –∑–∞–ø—Ä–æ—Å—ã (–∫—Ä–æ–º–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤)
- ‚ùå –ß–∏—Ç–∞—Ç—å `request` –æ–±—ä–µ–∫—Ç ‚Äî —Ç–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ task
- ‚ùå –ü–æ–¥–Ω–∏–º–∞—Ç—å exceptions –Ω–∞—Ä—É–∂—É ‚Äî —Ç–æ–ª—å–∫–æ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å
- ‚ùå –ú–µ–Ω—è—Ç—å —Å—Ç–∞—Ç—É—Å WebhookLog –Ω–∞ SUCCESS –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

---

## SLA –æ–±—Ä–∞–±–æ—Ç–∫–∏

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ | –ê–ª–µ—Ä—Ç |
|---------|----------|-------|
| Webhook ‚Üí PROCESSING | < 1 —Å–µ–∫ | ‚Äî |
| PROCESSING ‚Üí SUCCESS | < 30 —Å–µ–∫ | > 1 –º–∏–Ω |
| PROCESSING –∑–∞–≤–∏—Å—à–∏–π | > 10 –º–∏–Ω | retry_stuck_webhooks |
| FAILED –∑–∞ —á–∞—Å | > 5 | alert_failed_webhooks |

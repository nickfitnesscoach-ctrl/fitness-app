# Billing Webhooks (YooKassa)

Эта папка содержит **обработку webhook-уведомлений от YooKassa** для биллинга EatFit24.

Webhook — это **критическая часть платёжной системы**.  
Именно здесь система узнаёт, что платёж:
- прошёл успешно,
- был отменён,
- ожидает подтверждения,
- или был возвращён.

⚠️ **Фронтенд и клиент НЕ имеют к этому отношения.**  
Webhook — это прямой сервер-к-серверу вызов от YooKassa.

---

## Структура папки

billing/
└── webhooks/
├── init.py
├── views.py
├── handlers.py
└── utils.py

markdown
Копировать код

---

## Общая философия

> **Webhook = источник истины для денег и подписок**

- никакие статусы с фронта не принимаются
- никакие суммы не доверяются клиенту
- все решения принимаются **строго по данным из БД**

Разделение ответственности жёсткое:

| Файл | Ответственность |
|----|----------------|
| `views.py` | Безопасный приём webhook (IP, JSON, идемпотентность) |
| `handlers.py` | Бизнес-логика (Payment, Subscription, Refund) |
| `utils.py` | Вспомогательные функции (IP allowlist и т.п.) |
| `__init__.py` | Публичный API модуля |

---

## 1️⃣ `views.py` — точка входа webhook

### Что делает
- принимает `POST` запрос от YooKassa
- проверяет IP адрес (allowlist)
- валидирует JSON
- обеспечивает **идемпотентность** через `WebhookLog`
- передаёт событие в `handlers.py`
- **всегда отвечает `200 OK`**, если запрос валиден

### Почему это важно
YooKassa **будет ретраить webhook**, если:
- ответ не `200`
- сервер долго отвечает
- упал exception

Поэтому:
- ошибки бизнес-логики **не должны ломать endpoint**
- всё логируется, но YooKassa всегда получает `OK`

---

## 2️⃣ `handlers.py` — бизнес-логика

### Назначение
Здесь происходит **реальное изменение состояния системы**:

- обновление `Payment`
- продление `Subscription`
- обработка `Refund`
- включение автопродления
- сохранение карты

### Поддерживаемые события

| Событие YooKassa | Поведение |
|------------------|----------|
| `payment.succeeded` | Платёж успешен → продлеваем подписку |
| `payment.canceled` | Платёж отменён |
| `payment.waiting_for_capture` | Обновляем статус (редкий кейс) |
| `refund.succeeded` | Фиксируем возврат |

### Ключевые принципы
- всё в транзакциях
- защита от повторной обработки
- данные плана берутся **из БД**, а не из webhook
- webhook не может продлить подписку дважды

---

## 3️⃣ `utils.py` — утилиты безопасности

### Что здесь
- allowlist IP адресов YooKassa
- безопасная проверка IP
- вспомогательные функции без бизнес-логики

### Зачем IP-фильтрация
Webhook — публичный endpoint.  
Без allowlist **любой** может попытаться подделать событие.

Это не криптозащита, но **обязательный базовый слой**.

---

## 4️⃣ `__init__.py` — публичный API модуля

### Что экспортируется наружу
```python
from apps.billing.webhooks import yookassa_webhook
Что НЕ экспортируется
handlers

utils

внутренняя логика

Это защищает систему от:

случайного прямого вызова обработчиков

обхода идемпотентности

хаоса в импортах

Поток данных (упрощённо)
pgsql
Копировать код
YooKassa
   ↓
POST /billing/webhooks/yookassa
   ↓
views.py
  ├─ IP allowlist
  ├─ JSON parse
  ├─ WebhookLog (idempotency)
   ↓
handlers.py
  ├─ Payment update
  ├─ Subscription extend
  ├─ Refund processing
   ↓
200 OK
Важные правила
❌ Нельзя:

вызывать handlers напрямую

менять подписку вне webhook

доверять данным из payload без проверки в БД

✅ Можно:

логировать всё

безопасно ретраить webhook

повторно принимать одно и то же событие

Типовые проблемы
Платёж прошёл, но подписка не продлилась
Проверить:

Payment.status

Payment.webhook_processed_at

WebhookLog

логи сервера

Дублирующиеся события
Нормально.
Идемпотентность решает это автоматически.

Итог
Эта папка — сердце биллинга.

Если:

команды = фон

API = интерфейс

модели = состояние

то webhooks = правда о деньгах.

Любые изменения здесь должны делаться осторожно и осознанно.
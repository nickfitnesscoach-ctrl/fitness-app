# Final Security Report: billing/

> **–î–∞—Ç–∞:** 2024-12-17  
> **–°—Ç–∞—Ç—É—Å:** ‚úÖ Ready for Production (–ø—Ä–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–µ)

---

## –û–±—â–∏–π —Å—Ç–∞—Ç—É—Å

| –î–æ | –ü–æ—Å–ª–µ |
|----|-------|
| üî¥ 1 Critical | ‚úÖ 0 Critical |
| üü° 2 High | ‚úÖ 0 High |
| üü† 3 Medium | ‚úÖ 0 Medium |
| **Risk Level: HIGH** | **Risk Level: LOW** |

---

## –ó–∞–∫—Ä—ã—Ç—ã–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏

### Priority 1 ‚Äî Critical ‚úÖ

| # | –£—è–∑–≤–∏–º–æ—Å—Ç—å | –°—Ç–∞—Ç—É—Å |
|---|------------|--------|
| 1 | Throttles –Ω–µ –ø—Ä–∏–º–µ–Ω—è–ª–∏—Å—å –∫ endpoints | **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ** ‚Äî 6 endpoints –∑–∞—â–∏—â–µ–Ω—ã |
| 2 | XFF spoofing –≤ webhook | **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ** ‚Äî `WEBHOOK_TRUST_XFF=False` –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é |

### Priority 2 ‚Äî High ‚úÖ

| # | –£—è–∑–≤–∏–º–æ—Å—Ç—å | –°—Ç–∞—Ç—É—Å |
|---|------------|--------|
| 3 | Race condition –≤ –¥–Ω–µ–≤–Ω—ã—Ö –ª–∏–º–∏—Ç–∞—Ö | **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ** ‚Äî –∞—Ç–æ–º–∞—Ä–Ω—ã–π `check_and_increment_if_allowed()` |
| 4 | Test-–ø–ª–∞–Ω—ã —á–µ—Ä–µ–∑ –æ–±—ã—á–Ω—ã–π API | **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ** ‚Äî `is_test=False` —Ñ–∏–ª—å—Ç—Ä |

### Priority 3 ‚Äî Medium ‚úÖ

| # | –£—è–∑–≤–∏–º–æ—Å—Ç—å | –°—Ç–∞—Ç—É—Å |
|---|------------|--------|
| 5 | Open redirect —á–µ—Ä–µ–∑ `return_url` | **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ** ‚Äî whitelist –¥–æ–º–µ–Ω–æ–≤ |
| 6 | –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ YooKassa –∫–ª–∏–µ–Ω—Ç–æ–≤ | **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ** ‚Äî deprecated notice |

---

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–µ

> [!IMPORTANT]
> Billing –±–µ–∑–æ–ø–∞—Å–µ–Ω –¢–û–õ–¨–ö–û –ø—Ä–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–µ:

| –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ | –ö–æ–º–∞–Ω–¥–∞/–ù–∞—Å—Ç—Ä–æ–π–∫–∞ |
|------------|-------------------|
| –°–µ—Ä–≤–µ—Ä –∑–∞ Nginx/Cloudflare | `WEBHOOK_TRUST_XFF=true` (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ) |
| HTTPS –≤ production | `SECURE_SSL_REDIRECT=True` |
| Redis –¥–ª—è throttling | –£–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ `CACHES` |

---

## –û—Å—Ç–∞–≤—à–∏–µ—Å—è —Ä–∏—Å–∫–∏ (–Ω–∏–∑–∫–∏–µ)

| # | –†–∏—Å–∫ | Mitigation |
|---|------|------------|
| 1 | `WebhookLog.event_id` –±–µ–∑ `unique=True` | Code-level idempotency —Ä–∞–±–æ—Ç–∞–µ—Ç, DB constraint ‚Äî nice-to-have |
| 2 | `raw_payload` –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å card data | YooKassa –º–∞—Å–∫–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ, –Ω–æ —Å—Ç–æ–∏—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å retention policy |
| 3 | YooKassa webhook signature –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è | IP allowlist —Ä–∞–±–æ—Ç–∞–µ—Ç, signature ‚Äî defense-in-depth |

---

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –±—É–¥—É—â–µ–µ

> [!NOTE]
> –≠—Ç–∏ –ø—É–Ω–∫—Ç—ã –ù–ï –∫—Ä–∏—Ç–∏—á–Ω—ã, –Ω–æ —É–ª—É—á—à–∞—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:

1. **–î–æ–±–∞–≤–∏—Ç—å `unique=True` –Ω–∞ `WebhookLog.event_id`** ‚Äî DB-level –∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–µ–π
2. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å HMAC-–ø—Ä–æ–≤–µ—Ä–∫—É webhook** ‚Äî YooKassa –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∏
3. **–£–¥–∞–ª–∏—Ç—å `yookassa_client.py`** ‚Äî –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –≤—Å–µ–≥–æ –∫–æ–¥–∞ –Ω–∞ `YooKassaService`
4. **–î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –Ω–∞ throttling** ‚Äî —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ rate limit —Ä–µ–∞–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

---

## –ß–µ–∫–ª–∏—Å—Ç –¥–ª—è DevOps

```bash
# –í production env –¥–æ–±–∞–≤–∏—Ç—å:
WEBHOOK_TRUST_XFF=true  # –ï—Å–ª–∏ –∑–∞ Nginx/Cloudflare
ALLOWED_RETURN_URL_DOMAINS=eatfit24.ru,app.eatfit24.ru
```

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ú–æ–¥—É–ª—å `billing/` –≥–æ—Ç–æ–≤ –∫ production –ø—Ä–∏ —É—Å–ª–æ–≤–∏–∏:
- ‚úÖ –°–µ—Ä–≤–µ—Ä –∑–∞ trusted reverse proxy
- ‚úÖ HTTPS enabled
- ‚úÖ Redis –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è throttling

**–í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏ –≤—ã—Å–æ–∫–æ–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –∑–∞–∫—Ä—ã—Ç—ã.**

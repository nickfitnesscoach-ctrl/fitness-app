# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Deploy to VPS (EatFit24)

on:
  push:
    branches: [main]
    paths:
      - "backend/**"
      - "bot/**"
      - "frontend/**"
      - "compose.yml"
      - ".github/workflows/deploy.yml"
  workflow_dispatch:
    inputs:
      services:
        description: "Services to deploy (comma-separated or 'all')"
        required: false
        default: "all"
        type: string

concurrency:
  group: deploy-main
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Validate required secrets
        run: |
          MISSING=""
          [ -z "${{ secrets.VPS_HOST }}" ] && MISSING="$MISSING VPS_HOST"
          [ -z "${{ secrets.VPS_USERNAME }}" ] && MISSING="$MISSING VPS_USERNAME"
          [ -z "${{ secrets.VPS_SSH_KEY }}" ] && MISSING="$MISSING VPS_SSH_KEY"
          [ -z "${{ secrets.VPS_SUDO_PASSWORD }}" ] && MISSING="$MISSING VPS_SUDO_PASSWORD"

          if [ -n "$MISSING" ]; then
            echo "âŒ Missing required secrets:$MISSING"
            exit 1
          fi

          echo "âœ… Secrets OK"

      - name: Deploy to VPS (safe in-place update)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          command_timeout: 30m
          script_stop: false  # Let script handle errors with set -e
          debug: false  # Reduce noise in logs
          script: |
            set -e  # Exit on any error
            exec 2>&1  # Redirect stderr to stdout for better logging

            echo ">>> [1/9] Setup variables"
            PROJECT_DIR="/opt/EatFit24"
            BRANCH="main"
            REPO_URL="https://github.com/${{ github.repository }}.git"

            echo ">>> [2/9] Check project directory exists"
            if [ ! -d "${PROJECT_DIR}" ]; then
              echo "âŒ Project directory ${PROJECT_DIR} does not exist!"
              echo ">>> Creating directory and cloning repo for first-time setup..."
              echo "${{ secrets.VPS_SUDO_PASSWORD }}" | sudo -S mkdir -p "${PROJECT_DIR}"
              echo "${{ secrets.VPS_SUDO_PASSWORD }}" | sudo -S chown -R "${{ secrets.VPS_USERNAME }}:${{ secrets.VPS_USERNAME }}" "${PROJECT_DIR}"
              git clone --branch "${BRANCH}" "${REPO_URL}" "${PROJECT_DIR}"
              cd "${PROJECT_DIR}"
              echo ">>> âš ï¸ First-time setup complete. You MUST configure .env manually!"
              exit 1
            fi

            cd "${PROJECT_DIR}"

            echo ">>> [3/9] Check .env file exists"
            if [ ! -f ".env" ]; then
              echo "âŒ .env file missing! Cannot deploy without configuration."
              echo ">>> Copy .env.example to .env and configure it on the server."
              exit 1
            fi
            echo ">>> .env file exists âœ…"

            echo ">>> [4/9] Save current commit (for rollback)"
            PREV_COMMIT=$(git rev-parse HEAD 2>/dev/null || echo "none")
            echo ">>> Current commit: ${PREV_COMMIT}"

            echo ">>> [5/9] Update code from repository"
            git config --global --add safe.directory "${PROJECT_DIR}" 2>/dev/null || true

            # Clean any local changes and update code (temporarily disable set -e for git commands)
            set +e
            git clean -fd
            GIT_CLEAN_EXIT=$?
            echo ">>> git clean exit code: ${GIT_CLEAN_EXIT}"

            git checkout -- .
            GIT_CHECKOUT_EXIT=$?
            echo ">>> git checkout exit code: ${GIT_CHECKOUT_EXIT}"

            git fetch origin "${BRANCH}"
            FETCH_EXIT=$?
            echo ">>> git fetch exit code: ${FETCH_EXIT}"

            if [ ${FETCH_EXIT} -eq 0 ]; then
              # Normal update path - reset to fetched origin
              git reset --hard "origin/${BRANCH}"
              RESET_EXIT=$?
              echo ">>> git reset exit code: ${RESET_EXIT}"
            else
              RESET_EXIT=1
            fi

            echo ">>> Checking if git update succeeded..."
            echo ">>> FETCH_EXIT=${FETCH_EXIT}, RESET_EXIT=${RESET_EXIT:-1}"
            echo ">>> About to evaluate conditional..."

            if [ ${FETCH_EXIT} -ne 0 ] || [ ${RESET_EXIT:-1} -ne 0 ]; then
              echo ">>> Entering FAILURE branch (fresh clone)..."
              echo "âš ï¸ Git update failed, trying fresh clone as fallback..."
              cd /tmp
              TEMP_CLONE="/tmp/eatfit24_fresh_clone"
              rm -rf "${TEMP_CLONE}"
              git clone --branch "${BRANCH}" --depth 1 "${REPO_URL}" "${TEMP_CLONE}"

              # Preserve .env and backups/
              echo ">>> Preserving .env and backups..."
              cp "${PROJECT_DIR}/.env" "${TEMP_CLONE}/.env"
              [ -d "${PROJECT_DIR}/backups" ] && cp -r "${PROJECT_DIR}/backups" "${TEMP_CLONE}/"

              # Replace project dir
              echo "${{ secrets.VPS_SUDO_PASSWORD }}" | sudo -S rm -rf "${PROJECT_DIR}.old" || true
              echo "${{ secrets.VPS_SUDO_PASSWORD }}" | sudo -S mv "${PROJECT_DIR}" "${PROJECT_DIR}.old"
              echo "${{ secrets.VPS_SUDO_PASSWORD }}" | sudo -S mv "${TEMP_CLONE}" "${PROJECT_DIR}"
              echo "${{ secrets.VPS_SUDO_PASSWORD }}" | sudo -S chown -R "${{ secrets.VPS_USERNAME }}:${{ secrets.VPS_USERNAME }}" "${PROJECT_DIR}"
              cd "${PROJECT_DIR}"
            else
              echo ">>> Entering SUCCESS branch (in-place update)..."
              echo ">>> Code updated to latest ${BRANCH} âœ…"
            fi

            echo ">>> Exited conditional successfully"
            echo ">>> Getting new commit hash..."
            NEW_COMMIT=$(git rev-parse HEAD)
            echo ">>> New commit: ${NEW_COMMIT}"
            echo ">>> Current working directory: $(pwd)"
            echo ">>> Continuing to next step..."

            # Re-enable exit on error after all git operations complete
            set -e

            echo ">>> [6/9] Verify compose file"
            if [ ! -f "compose.yml" ]; then
              echo "âŒ compose.yml not found!"
              exit 1
            fi

            echo ">>> [7/9] Rebuild and restart services"
            set +e  # Temporarily disable exit on error to capture exit code
            docker compose -f compose.yml up -d --build 2>&1
            DEPLOY_EXIT_CODE=$?
            set -e  # Re-enable exit on error

            if [ ${DEPLOY_EXIT_CODE} -ne 0 ]; then
              echo "âŒ Docker compose failed with exit code ${DEPLOY_EXIT_CODE}"
              echo ">>> Dumping docker compose logs..."
              docker compose logs --tail 100 2>&1 || true

              if [ "${PREV_COMMIT}" != "none" ]; then
                echo ">>> Attempting rollback to ${PREV_COMMIT}..."
                git reset --hard "${PREV_COMMIT}"
                set +e
                docker compose -f compose.yml up -d --build 2>&1
                ROLLBACK_EXIT=$?
                set -e

                if [ ${ROLLBACK_EXIT} -eq 0 ]; then
                  echo "âœ… Rollback successful"
                  exit 0  # Exit successfully after rollback
                else
                  echo "âŒ Rollback also failed with exit code ${ROLLBACK_EXIT}"
                  echo ">>> Manual intervention required."
                  docker compose logs --tail 100 2>&1 || true
                fi
              fi

              exit 1
            fi

            echo ">>> [8/9] Wait for services to start"
            sleep 20

            echo ">>> [9/9] Health checks"
            echo ">>> Container status:"
            docker compose ps

            echo ""
            echo ">>> Backend health check..."
            BACKEND_OK=0
            for i in 1 2 3 4 5 6; do
              if curl -fsS -H "Host: eatfit24.ru" http://127.0.0.1:8000/health/ >/dev/null 2>&1; then
                echo "âœ… Backend healthy"
                BACKEND_OK=1
                break
              fi
              echo ">>> Backend not ready ($i/6), waiting..."
              sleep 5
            done

            if [ ${BACKEND_OK} -eq 0 ]; then
              echo "âŒ Backend health check failed!"
              echo ">>> Backend logs:"
              docker logs --tail 50 eatfit24-backend
              exit 1
            fi

            echo ""
            echo ">>> Frontend health check..."
            if curl -fsS http://127.0.0.1:3000/ >/dev/null 2>&1; then
              echo "âœ… Frontend healthy (port 3000)"
            else
              echo "âš ï¸ Frontend not responding on port 3000"
              echo ">>> Frontend logs:"
              docker logs --tail 30 eatfit24-frontend
            fi

            echo ""
            echo ">>> Public HTTPS check..."
            HTTP_CODE=$(curl -LsS -o /dev/null -w "%{http_code}" --max-time 10 https://eatfit24.ru/health/ 2>&1 || echo "000")
            if [ "${HTTP_CODE}" = "200" ]; then
              echo "âœ… Public website healthy (200)"
            else
              echo "âš ï¸ Public website health check failed (code=${HTTP_CODE})"
              echo ">>> This may indicate SSL/Nginx issues or backend problems"
            fi

            echo ""
            echo "ðŸŽ‰ Deploy completed successfully!"
            echo ">>> Deployed commit: ${NEW_COMMIT}"

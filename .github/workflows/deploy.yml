# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Deploy to VPS (EatFit24)

on:
  push:
    branches: [main]
    paths:
      - "backend/**"
      - "bot/**"
      - "frontend/**"
      - "compose.yml"
      - ".github/workflows/deploy.yml"
  workflow_dispatch:
    inputs:
      services:
        description: "Services to deploy (comma-separated or 'all')"
        required: false
        default: "all"
        type: string

concurrency:
  group: deploy-main
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Validate required secrets
        run: |
          MISSING=""
          [ -z "${{ secrets.VPS_HOST }}" ] && MISSING="$MISSING VPS_HOST"
          [ -z "${{ secrets.VPS_USERNAME }}" ] && MISSING="$MISSING VPS_USERNAME"
          [ -z "${{ secrets.VPS_SSH_KEY }}" ] && MISSING="$MISSING VPS_SSH_KEY"
          [ -z "${{ secrets.VPS_SUDO_PASSWORD }}" ] && MISSING="$MISSING VPS_SUDO_PASSWORD"

          if [ -n "$MISSING" ]; then
            echo "âŒ Missing required secrets:$MISSING"
            exit 1
          fi

          echo "âœ… Secrets OK"

      - name: Deploy to VPS (safe in-place update)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          command_timeout: 30m
          script_stop: true  # Stop on first error
          debug: true
          script: |
            set -e  # Exit on any error

            echo ">>> [1/9] Setup variables"
            PROJECT_DIR="/opt/EatFit24"
            BRANCH="main"
            REPO_URL="https://github.com/${{ github.repository }}.git"

            echo ">>> [2/9] Check project directory exists"
            if [ ! -d "${PROJECT_DIR}" ]; then
              echo "âŒ Project directory ${PROJECT_DIR} does not exist!"
              echo ">>> Creating directory and cloning repo for first-time setup..."
              echo "${{ secrets.VPS_SUDO_PASSWORD }}" | sudo -S mkdir -p "${PROJECT_DIR}"
              echo "${{ secrets.VPS_SUDO_PASSWORD }}" | sudo -S chown -R "${{ secrets.VPS_USERNAME }}:${{ secrets.VPS_USERNAME }}" "${PROJECT_DIR}"
              git clone --branch "${BRANCH}" "${REPO_URL}" "${PROJECT_DIR}"
              cd "${PROJECT_DIR}"
              echo ">>> âš ï¸ First-time setup complete. You MUST configure .env manually!"
              exit 1
            fi

            cd "${PROJECT_DIR}"

            echo ">>> [3/9] Check .env file exists"
            if [ ! -f ".env" ]; then
              echo "âŒ .env file missing! Cannot deploy without configuration."
              echo ">>> Copy .env.example to .env and configure it on the server."
              exit 1
            fi
            echo ">>> .env file exists âœ…"

            echo ">>> [4/9] Save current commit (for rollback)"
            PREV_COMMIT=$(git rev-parse HEAD 2>/dev/null || echo "none")
            echo ">>> Current commit: ${PREV_COMMIT}"

            echo ">>> [5/9] Update code from repository"
            git config --global --add safe.directory "${PROJECT_DIR}" 2>/dev/null || true

            # Stash any local changes (from previous manual edits on server)
            git stash --include-untracked || true

            # Fetch latest changes
            if ! git fetch origin "${BRANCH}"; then
              echo "âš ï¸ Git fetch failed, trying fresh clone as fallback..."
              cd /tmp
              TEMP_CLONE="/tmp/eatfit24_fresh_clone"
              rm -rf "${TEMP_CLONE}"
              git clone --branch "${BRANCH}" --depth 1 "${REPO_URL}" "${TEMP_CLONE}"

              # Preserve .env and backups/
              echo ">>> Preserving .env and backups..."
              cp "${PROJECT_DIR}/.env" "${TEMP_CLONE}/.env"
              [ -d "${PROJECT_DIR}/backups" ] && cp -r "${PROJECT_DIR}/backups" "${TEMP_CLONE}/"

              # Replace project dir
              echo "${{ secrets.VPS_SUDO_PASSWORD }}" | sudo -S rm -rf "${PROJECT_DIR}.old" || true
              echo "${{ secrets.VPS_SUDO_PASSWORD }}" | sudo -S mv "${PROJECT_DIR}" "${PROJECT_DIR}.old"
              echo "${{ secrets.VPS_SUDO_PASSWORD }}" | sudo -S mv "${TEMP_CLONE}" "${PROJECT_DIR}"
              echo "${{ secrets.VPS_SUDO_PASSWORD }}" | sudo -S chown -R "${{ secrets.VPS_USERNAME }}:${{ secrets.VPS_USERNAME }}" "${PROJECT_DIR}"
              cd "${PROJECT_DIR}"
            else
              # Normal update path - reset to fetched origin
              git reset --hard "origin/${BRANCH}"
              echo ">>> Code updated to latest ${BRANCH} âœ…"
            fi

            NEW_COMMIT=$(git rev-parse HEAD)
            echo ">>> New commit: ${NEW_COMMIT}"

            echo ">>> [6/9] Verify compose file"
            if [ ! -f "compose.yml" ]; then
              echo "âŒ compose.yml not found!"
              exit 1
            fi

            echo ">>> [7/9] Rebuild and restart services"
            echo "${{ secrets.VPS_SUDO_PASSWORD }}" | sudo -S docker compose -f compose.yml up -d --build

            DEPLOY_EXIT_CODE=$?

            if [ ${DEPLOY_EXIT_CODE} -ne 0 ]; then
              echo "âŒ Docker compose failed with exit code ${DEPLOY_EXIT_CODE}"

              if [ "${PREV_COMMIT}" != "none" ]; then
                echo ">>> Attempting rollback to ${PREV_COMMIT}..."
                git reset --hard "${PREV_COMMIT}"
                echo "${{ secrets.VPS_SUDO_PASSWORD }}" | sudo -S docker compose -f compose.yml up -d --build

                if [ $? -eq 0 ]; then
                  echo "âœ… Rollback successful"
                else
                  echo "âŒ Rollback also failed! Manual intervention required."
                fi
              fi

              exit 1
            fi

            echo ">>> [8/9] Wait for services to start"
            sleep 20

            echo ">>> [9/9] Health checks"
            echo ">>> Container status:"
            echo "${{ secrets.VPS_SUDO_PASSWORD }}" | sudo -S docker compose ps

            echo ""
            echo ">>> Backend health check..."
            BACKEND_OK=0
            for i in 1 2 3 4 5 6; do
              if curl -fsS -H "Host: eatfit24.ru" http://127.0.0.1:8000/health/ >/dev/null 2>&1; then
                echo "âœ… Backend healthy"
                BACKEND_OK=1
                break
              fi
              echo ">>> Backend not ready ($i/6), waiting..."
              sleep 5
            done

            if [ ${BACKEND_OK} -eq 0 ]; then
              echo "âŒ Backend health check failed!"
              echo ">>> Backend logs:"
              echo "${{ secrets.VPS_SUDO_PASSWORD }}" | sudo -S docker logs --tail 50 eatfit24-backend
              exit 1
            fi

            echo ""
            echo ">>> Frontend health check..."
            if curl -fsS http://127.0.0.1:3000/ >/dev/null 2>&1; then
              echo "âœ… Frontend healthy (port 3000)"
            else
              echo "âš ï¸ Frontend not responding on port 3000"
              echo ">>> Frontend logs:"
              echo "${{ secrets.VPS_SUDO_PASSWORD }}" | sudo -S docker logs --tail 30 eatfit24-frontend
            fi

            echo ""
            echo ">>> Public HTTPS check..."
            if curl -fsS https://eatfit24.ru/health/ >/dev/null 2>&1; then
              echo "âœ… Public website healthy (https://eatfit24.ru/health/)"
            else
              echo "âš ï¸ Public website not responding"
            fi

            echo ""
            echo "ðŸŽ‰ Deploy completed successfully!"
            echo ">>> Deployed commit: ${NEW_COMMIT}"

# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Deploy to VPS (EatFit24)

on:
  push:
    branches: [main]
    paths:
      - "backend/**"
      - "bot/**"
      - "frontend/**"
      - "compose.yml"
      - ".github/workflows/deploy.yml"
  workflow_dispatch:
    inputs:
      services:
        description: "Services to deploy (comma-separated or 'all')"
        required: false
        default: "all"
        type: string

concurrency:
  group: deploy-main
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Validate required secrets
        run: |
          MISSING=""
          [ -z "${{ secrets.VPS_HOST }}" ] && MISSING="$MISSING VPS_HOST"
          [ -z "${{ secrets.VPS_USERNAME }}" ] && MISSING="$MISSING VPS_USERNAME"
          [ -z "${{ secrets.VPS_SSH_KEY }}" ] && MISSING="$MISSING VPS_SSH_KEY"
          [ -z "${{ secrets.VPS_SUDO_PASSWORD }}" ] && MISSING="$MISSING VPS_SUDO_PASSWORD"

          if [ -n "$MISSING" ]; then
            echo "âŒ Missing required secrets:$MISSING"
            exit 1
          fi

          echo "âœ… Secrets OK"

      - name: Deploy all services to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          command_timeout: 30m
          script_stop: false
          debug: true
          script: |
            echo ">>> [1/8] Setup variables"
            PROJECT_DIR="/opt/EatFit24"
            ENV_BACKUP="/tmp/eatfit24_env_backup"
            BRANCH="main"
            DEPLOY_USER="${{ secrets.VPS_USERNAME }}"
            REPO_URL="https://github.com/${{ github.repository }}.git"
            
            echo ">>> [2/8] Backup .env file if exists"
            if [ -f "${PROJECT_DIR}/.env" ]; then
              cp "${PROJECT_DIR}/.env" "${ENV_BACKUP}"
              echo ">>> .env backed up to ${ENV_BACKUP}"
            else
              echo ">>> No .env file found to backup"
            fi
            
            echo ">>> [3/8] Clean and create project dir"
            echo "${{ secrets.VPS_SUDO_PASSWORD }}" | sudo -S rm -rf "${PROJECT_DIR}" || true
            echo "${{ secrets.VPS_SUDO_PASSWORD }}" | sudo -S mkdir -p "${PROJECT_DIR}"
            echo "${{ secrets.VPS_SUDO_PASSWORD }}" | sudo -S chown -R "${DEPLOY_USER}:${DEPLOY_USER}" "${PROJECT_DIR}"
            
            echo ">>> [4/8] Clone fresh repo"
            git config --global --add safe.directory "${PROJECT_DIR}" 2>/dev/null || true
            git clone --branch "${BRANCH}" --depth 1 "${REPO_URL}" "${PROJECT_DIR}"
            if [ $? -ne 0 ]; then
              echo "âŒ Git clone failed!"
              exit 1
            fi
            
            cd "${PROJECT_DIR}"
            
            echo ">>> [5/8] Restore .env file"
            if [ -f "${ENV_BACKUP}" ]; then
              cp "${ENV_BACKUP}" "${PROJECT_DIR}/.env"
              rm -f "${ENV_BACKUP}"
              echo ">>> .env restored from backup"
            else
              echo ">>> âš ï¸ No .env backup found!"
              echo ">>> Creating minimal .env from .env.example..."
              if [ -f ".env.example" ]; then
                cp .env.example .env
                echo ">>> Created .env from .env.example - YOU NEED TO UPDATE IT ON SERVER!"
              else
                echo ">>> âŒ No .env.example found! Deploy may fail!"
              fi
            fi
            
            echo ">>> Files:"
            ls -la
            
            echo ">>> [6/8] Check compose file"
            if [ -f "compose.yml" ]; then
              COMPOSE_FILE="compose.yml"
            elif [ -f "docker-compose.yml" ]; then
              COMPOSE_FILE="docker-compose.yml"
            else
              echo "âŒ No compose file found!"
              exit 1
            fi
            echo ">>> Using: ${COMPOSE_FILE}"
            
            echo ">>> [7/8] Docker compose version"
            echo "${{ secrets.VPS_SUDO_PASSWORD }}" | sudo -S docker compose version
            
            echo ">>> [8/8] Build and deploy all services"
            echo "${{ secrets.VPS_SUDO_PASSWORD }}" | sudo -S docker compose -f "${COMPOSE_FILE}" up -d --build
            if [ $? -ne 0 ]; then
              echo "âŒ Docker compose failed!"
              exit 1
            fi
            
            echo ">>> Health checks"
            sleep 15
            
            echo ">>> Container status:"
            echo "${{ secrets.VPS_SUDO_PASSWORD }}" | sudo -S docker compose -f "${COMPOSE_FILE}" ps
            
            echo ">>> Checking backend health..."
            for i in 1 2 3 4 5; do
              if curl -fsS http://127.0.0.1:8000/health/ >/dev/null 2>&1; then
                echo "âœ… Backend OK"
                break
              fi
              echo ">>> Backend not ready ($i/5), waiting..."
              sleep 5
            done
            
            echo ">>> Checking frontend (port 80)..."
            curl -fsS http://127.0.0.1/ >/dev/null 2>&1 && echo "âœ… Frontend OK" || echo "âš ï¸ Frontend not responding"
            
            echo ""
            echo "ğŸ‰ Deploy completed!"


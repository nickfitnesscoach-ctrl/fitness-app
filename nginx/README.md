# Nginx конфигурация для EatFit24

## Что это?

Nginx — это веб-сервер, который стоит "на входе" и распределяет запросы:
- Запросы к `/api/` → отправляет на Django (бэкенд)
- Запросы к `/` → отправляет на React (фронтенд)
- Запросы к `/media/` → отдаёт файлы напрямую (фото, аватарки)

## Файлы в этой папке

| Файл | Что делает |
|------|------------|
| `eatfit24.ru` | Основной конфиг сайта |
| `snippets/websocket_map.conf` | Опциональный snippet для WebSocket (подключается ТОЛЬКО в `http{}` nginx.conf) |

## ВАЖНО: Telegram авторизация

Бэкенд ожидает заголовок:
```
X-Telegram-Init-Data
```

Если nginx прокидывает другой заголовок (например `X-TG-INIT-DATA`) — **авторизация НЕ БУДЕТ работать**.

Это критично для Telegram Mini App.

## Как установить

### Шаг 1: Скопировать конфиг на сервер

```bash
sudo cp /opt/eatfit24/nginx/eatfit24.ru /etc/nginx/sites-available/eatfit24.ru
```

### Шаг 2: Включить сайт

```bash
sudo ln -sf /etc/nginx/sites-available/eatfit24.ru /etc/nginx/sites-enabled/eatfit24.ru
```

### Шаг 3: Проверить что нет ошибок

```bash
sudo nginx -t
```

Если видишь `syntax is ok` и `test is successful` — всё хорошо.

### Шаг 4: Применить изменения

```bash
sudo systemctl reload nginx
```

## Как проверить что работает

### Быстрая проверка

```bash
curl -i https://eatfit24.ru/api/v1/billing/me/ \
  -H 'X-Telegram-Init-Data: test'
```

Должен вернуться ответ 401 или 403 — это нормально (мы послали неправильный токен).
Главное что сервер ответил, а не выдал ошибку 502 или таймаут.

### Полный smoke test

```bash
./ops/health/check-prod-smoke.sh
```

Автоматически проверяет: доступность сайта, health бэкенда, CORS, защиту API.

## Что настроено в конфиге

### Таймауты (время ожидания ответа)

| Путь | Таймаут | Почему |
|------|---------|--------|
| `/api/v1/ai/*` | 150 сек | AI-распознавание фото может занять до 2 минут |
| `/api/*` | 60 сек | Обычные запросы, отчёты |
| Остальное | стандарт | Фронтенд, статика |

### Безопасность

- HTTPS обязателен (HTTP автоматически перенаправляется)
- Защита от XSS, clickjacking и других атак через заголовки
- Файлы `/media/` защищены от обхода путей

## Частые проблемы

### Ошибка "502 Bad Gateway"
Бэкенд не запущен или упал. Проверь:
```bash
docker ps | grep backend
docker logs eatfit24-backend-1 --tail 50
```

### Ошибка "504 Gateway Timeout"
Запрос слишком долгий. AI-запросы могут обрабатываться до 2 минут.
Если 504 возникает раньше — проверь таймауты в nginx и на бэкенде.

### Сайт не открывается после изменений
1. Проверь синтаксис: `sudo nginx -t`
2. Посмотри логи: `sudo tail -f /var/log/nginx/error.log`

### Авторизация не работает (всегда 401)
Проверь что заголовок доходит до бэкенда:
```bash
docker logs eatfit24-backend-1 | grep -i telegram
```

### Ошибка "directive map is not allowed here"
Файл `websocket_map.conf` подключён в неправильном месте.
Его нельзя подключать внутри `server{}` — только внутри `http{}` в `/etc/nginx/nginx.conf`.

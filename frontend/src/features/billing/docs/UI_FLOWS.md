# UI FLOWS — Billing Feature Module

> Пошаговые сценарии взаимодействия пользователя с биллингом.

---

## Flow 1: Покупка PRO подписки

```
┌─────────────────────────────────────────────────────────────┐
│  1. Пользователь открывает /subscription                     │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  2. Видит карточки тарифов: FREE, PRO месяц, PRO год        │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  3. Нажимает "Оформить подписку" на PRO_MONTHLY             │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  4. useSubscriptionActions.handleSelectPlan(planId)          │
│     → api.createPayment({ plan_code, save_payment_method })  │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  5. Backend возвращает { confirmation_url }                  │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  6. Telegram.WebApp.openLink(confirmation_url)               │
│     → Редирект на страницу оплаты YooKassa                  │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  7. Пользователь вводит данные карты и оплачивает           │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  8. YooKassa:                                                │
│     → Webhook на backend → активация подписки                │
│     → Redirect на return_url                                 │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  9. Пользователь возвращается в приложение                  │
│     → BillingContext.refresh() → UI обновляется             │
└─────────────────────────────────────────────────────────────┘
```

**Файлы:**
- `SubscriptionPage.tsx` — страница выбора тарифа
- `PlanCard.tsx` — orchestrator компонент карточки
- `BasicPlanCard.tsx` / `PremiumMonthCard.tsx` / `PremiumProCard.tsx` — presentational карточки
- `PlanPriceStack.tsx` — компонент отображения цен
- `useSubscriptionActions.ts` — хук с логикой оплаты
- `utils/planCardState.tsx` — логика состояния карточки
- `utils/text.tsx` — утилиты для очистки текста и иконок
- `api/billing.ts` — API calls
- `BillingContext.tsx` — глобальный контекст

---

## Flow 2: Привязка карты

```
┌─────────────────────────────────────────────────────────────┐
│  1. Пользователь на /settings/subscription                  │
│     Видит "Способ оплаты: Карта не привязана"               │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  2. Нажимает на "Способ оплаты"                             │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  3. useSubscriptionDetails.handlePaymentMethodClick()        │
│     → billing.addPaymentMethod()                             │
│     → api.bindCard() → POST /billing/bind-card/start/        │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  4. Backend создаёт платёж 1₽ для привязки карты            │
│     → Возвращает { confirmation_url }                        │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  5. Редирект на YooKassa → пользователь вводит карту        │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  6. Успех: карта привязана, autorenew_available = true      │
└─────────────────────────────────────────────────────────────┘
```

---

## Flow 3: Toggle Auto-Renew

```
┌─────────────────────────────────────────────────────────────┐
│  1. Пользователь на /settings/subscription                  │
│     Видит toggle "Автопродление PRO"                        │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  2. Нажимает на toggle                                       │
│     handleToggleAutoRenew()                                  │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  3. POST /billing/subscription/autorenew/                    │
│     { enabled: !currentValue }                               │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  4. Backend toggles autorenew                                │
│     → Возвращает обновлённый SubscriptionDetails            │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  5. UI обновляется, showToast("Автопродление включено")     │
└─────────────────────────────────────────────────────────────┘
```

---

## Flow 4: История платежей

```
/settings/subscription
    ↓ Клик "История оплат"
/settings/history
    ↓ usePaymentHistory() загружает данные
    ↓ PaymentHistoryList рендерит список
```

---

## Flow 5: Daily Limit → Переход на подписку

```
┌─────────────────────────────────────────────────────────────┐
│  1. Пользователь на /log загружает фото                     │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  2. Backend возвращает DAILY_LIMIT_REACHED                   │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  3. useFoodBatchAnalysis обнаруживает ошибку                │
│     → onDailyLimitReached() → showLimitModal(true)          │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  4. Модалка: "Лимит исчерпан. Оформите PRO"                 │
│     Кнопка "Оформить PRO"                                   │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  5. navigate('/subscription')                                │
└─────────────────────────────────────────────────────────────┘
```

---

## Flow 6: Plan Card Visual States

Карточки тарифных планов отображают различные состояния в зависимости от подписки пользователя.

### State 1: Not Current (Default)

```
FREE user → PRO card
  ├─ Button: "ОФОРМИТЬ ПОДПИСКУ"
  ├─ Enabled: true
  └─ bottomContent: none
```

### State 2: Current Plan (Active)

```
PRO_MONTHLY user → PRO_MONTHLY card
  ├─ Button custom text (disabled)
  ├─ bottomContent:
      ├─ Expires: "Доступ до [date]"
      ├─ Card info (if attached)
      └─ AutoRenew toggle/button
```

### State 3: Expired Plan

```
Expired PRO user → PRO card
  ├─ bottomContent:
      ├─ Warning: "Подписка истекла [date]"
      └─ Button: "Восстановить за [price]₽"
```

### State 4: Loading

```
User clicks "ОФОРМИТЬ ПОДПИСКУ"
  └─ Button shows spinner + "Ждем..."
```

**Логика определения:**
- Реализована в `utils/planCardState.tsx` → `buildPlanCardState()`
- Учитывает: `subscription.plan`, `subscription.is_active`, `billingMe.plan_code`
- Возвращает: `{ isCurrent, disabled, customButtonText, bottomContent }`


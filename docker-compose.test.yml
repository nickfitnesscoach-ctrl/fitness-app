# EatFit24 - Docker Compose for Tests
# Isolated test environment with SQLite in-memory (no external dependencies)
#
# Usage:
#   docker-compose -f docker-compose.test.yml build
#   docker-compose -f docker-compose.test.yml run --rm test
#
# This runs pytest in a clean container without PostgreSQL/Redis

services:
  test:
    build:
      context: ./backend
      dockerfile: Dockerfile
    entrypoint: []
    command: >
      sh -c "
        echo 'Running AI tests...' &&
        python -m pytest apps/ai/tests -v --tb=short &&
        echo 'All tests passed!'
      "
    environment:
      # Test settings - SQLite in-memory, no Redis
      - DJANGO_SETTINGS_MODULE=config.settings.test
      - SECRET_KEY=test-secret-key-for-docker-testing-only
      # Dummy values for imports (not used in tests with mocks)
      - AI_PROXY_URL=http://mock-proxy:8080
      - AI_PROXY_SECRET=mock-secret
      - TELEGRAM_BOT_TOKEN=test:token
      - TELEGRAM_ADMINS=123456789
      - ALLOWED_HOSTS=localhost,testserver
    volumes:
      # Mount source code for live updates during development
      - ./backend:/app:ro
    working_dir: /app
    # No network needed - tests use mocks
    # No dependencies - fully isolated
